name: Build and Deploy

on:
  push:
    branches: [main]
    paths: ['app/**', 'frontend/**', 'requirements.txt', 'Dockerfile', '.github/workflows/docker-build.yml']
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: proposal-generator

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::605600142754:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push with cache
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker buildx build \
            --cache-from type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:cache \
            --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:cache,mode=max \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            --push .
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::605600142754:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to ECS
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          sed -i "s|REPLACED_BY_CICD|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" ecs-task-def.json
          TASK_ARN=$(aws ecs register-task-definition --cli-input-json file://ecs-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service --cluster proposal-generator-cluster --service proposal-generator-service --task-definition $TASK_ARN --force-new-deployment
          echo "✅ ECS deployment triggered: $TASK_ARN"

      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/ s3://genproposals.com/ --delete --cache-control "max-age=0,no-cache,no-store,must-revalidate"
          echo "✅ Frontend deployed"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation --distribution-id E2FANG0M4M7PYU --paths "/*"
          echo "✅ Cache invalidated"

      - name: Verify deployment
        run: |
          sleep 30
          for i in {1..6}; do
            STATUS=$(aws ecs describe-services --cluster proposal-generator-cluster --services proposal-generator-service --query 'services[0].deployments[0].runningCount' --output text)
            if [ "$STATUS" -ge 1 ]; then echo "✅ Service running"; exit 0; fi
            echo "Waiting... ($i/6)"; sleep 10
          done
          echo "⚠️ Deployment in progress (check ECS console)"
