<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #ffffff; color: #1a1a1a; }
        
        .form-input { 
            background: #f5f5f5; 
            border: 1px solid #e0e0e0; 
            transition: all 0.2s ease; 
        }
        .form-input:focus { 
            background: #ffffff; 
            border-color: #1a1a1a; 
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }
        
        .proposal-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 24px;
        }
        
        .copy-btn {
            position: relative;
        }
        
        .copy-feedback {
            position: absolute;
            right: 0;
            top: -30px;
            background: #1a1a1a;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        
        .copy-feedback.show {
            opacity: 1;
        }
        
        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e8e8e8;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .skill-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            color: #666;
        }
        
        .skill-tag button:hover {
            color: #1a1a1a;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .insight-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f0f0f0;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .quality-metric {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .quality-metric:last-child {
            border-bottom: none;
        }
        
        .quality-bar {
            width: 100px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .quality-fill {
            height: 100%;
            background: #1a1a1a;
            transition: width 0.3s;
        }
        
        .nav-link {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .nav-link:hover {
            color: #1a1a1a;
        }
        
        .nav-link.active {
            color: #1a1a1a;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-6xl mx-auto px-8 py-5">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-700 tracking-tight text-black">Proposal Generator</h1>
                    <p class="text-xs text-gray-500 mt-1 font-500 tracking-wide">AI-POWERED SHORT & WINNING</p>
                </div>
                <div class="flex gap-6">
                    <a href="index.html" class="nav-link">‚Üê Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-8 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- LEFT: Input Form -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-gray-200 rounded-lg p-8 sticky top-24">
                    <h2 class="text-lg font-700 text-black mb-6">New Proposal</h2>
                    
                    <form id="proposal-form" class="space-y-5">

                        <!-- Task Type -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-2">Task Type *</label>
                            <select 
                                id="task_type"
                                name="task_type"
                                class="w-full px-4 py-2.5 form-input rounded-6px text-sm"
                                required
                            >
                            <option value="">Select type</option>
                            <option value="complete_website">Complete Website</option>
                            <option value="enhance_functionality">Enhance Functionality</option>
                            <option value="redesign_website">Redesign Website</option>
                            <option value="bug_fixes">Bug Fixes</option>
                            <option value="speed_optimization">Speed Optimization</option>
                            <option value="layout_change">Layout Change</option>
                            <option value="web_designing">Designing</option>
                            <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Skills -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-2">Skills Required * (comma-separated)</label>
                            <div class="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    id="skill-input"
                                    placeholder="e.g., Python, FastAPI, PostgreSQL"
                                    class="flex-1 px-3 py-2 form-input rounded-6px text-sm"
                                />
                                <button 
                                    type="button" 
                                    onclick="addSkills()"
                                    class="px-4 py-2 bg-black text-white rounded-6px font-600 text-sm hover:bg-gray-800 whitespace-nowrap"
                                >
                                    Add All
                                </button>
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2 mb-2"></div>
                            <input type="hidden" id="skills-hidden" value="[]" />
                            <p class="text-xs text-gray-500 mt-1">Separate multiple skills with commas</p>
                        </div>

                        <!-- Job Description -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-2">Job Description *</label>
                            <textarea 
                                id="job_description"
                                name="job_description"
                                placeholder="Paste the full job description..."
                                rows="8"
                                class="w-full px-4 py-2.5 form-input rounded-6px text-sm resize-none"
                                required
                            ></textarea>
                            <p class="text-xs text-gray-500 mt-1">Include: company, goals, tech stack, requirements</p>
                        </div>

                        <!-- Generate Button -->
                        <button 
                            type="submit"
                            id="generate-btn"
                            class="w-full px-6 py-3 bg-black text-white rounded-6px font-700 text-sm hover:bg-gray-800 transition-all disabled:opacity-50"
                        >
                            Generate Proposal
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT: Output & Insights -->
            <div class="lg:col-span-2">
                <!-- Loading State -->
                <div id="loading-state" class="hidden">
                    <div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
                        <div class="inline-block mb-4">
                            <div class="loading-spinner"></div>
                        </div>
                        <h3 class="font-600 text-black mb-2">Generating Proposal...</h3>
                        <p class="text-sm text-gray-600">Analyzing past projects & extracting insights</p>
                    </div>
                </div>

                <!-- Result State -->
                <div id="result-state" class="hidden space-y-6">
                    
                    <!-- Proposal -->
                    <div class="proposal-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-700 text-black mb-1">Generated Proposal</h3>
                                <p class="text-xs text-gray-600">
                                    <span id="word-count">0</span> words ¬∑ 
                                    Quality: <span id="quality-score">0</span>%
                                </p>
                            </div>
                            <button 
                                type="button" 
                                onclick="copyToClipboard()"
                                class="copy-btn px-4 py-2 bg-black text-white rounded-6px font-600 text-sm hover:bg-gray-800 transition-all relative"
                            >
                                üìã Copy
                                <span class="copy-feedback" id="copy-feedback">Copied!</span>
                            </button>
                        </div>
                        
                        <div id="proposal-text" class="text-sm leading-relaxed text-gray-700 whitespace-pre-wrap mb-4 font-400"></div>
                        
                        <!-- Quality Metrics -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <p class="text-xs font-600 text-gray-600 mb-3 uppercase">Quality Breakdown</p>
                            <div id="quality-metrics" class="space-y-2 text-xs"></div>
                        </div>
                    </div>

                    <!-- References & Insights -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Similar Projects -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-700 text-black mb-4">Past Similar Projects</h4>
                            <div id="similar-projects" class="space-y-3 text-sm">
                                <p class="text-gray-600">None found</p>
                            </div>
                        </div>

                        <!-- Success Patterns -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="font-700 text-black mb-4">Success Patterns</h4>
                            <div id="success-patterns" class="space-y-2">
                                <p class="text-gray-600 text-sm">None extracted</p>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio Links -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-700 text-black mb-4">Portfolio References</h4>
                        <div id="portfolio-links" class="space-y-2 text-sm">
                            <p class="text-gray-600">None included</p>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="empty-state">
                    <div class="bg-white border border-gray-200 rounded-lg p-12 text-center">
                        <div class="text-4xl mb-4">üìù</div>
                        <h3 class="font-700 text-black mb-2">Fill in the details</h3>
                        <p class="text-sm text-gray-600 max-w-sm mx-auto">
                            Add company name, job details, and required skills. The AI will find similar past projects and generate a SHORT, WINNING proposal (max 150 words).
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/proposals';
        let currentSkills = [];

        // Add skills (comma-separated)
        function addSkills() {
            const input = document.getElementById('skill-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Split by comma and add each skill
            const skills = text.split(',').map(s => s.trim()).filter(s => s && !currentSkills.includes(s));
            
            if (skills.length > 0) {
                currentSkills.push(...skills);
                updateSkillsDisplay();
                input.value = '';
                input.focus();
            }
        }

        // Remove skill
        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            updateSkillsDisplay();
        }

        // Update skills display
        function updateSkillsDisplay() {
            const container = document.getElementById('skills-container');
            const hidden = document.getElementById('skills-hidden');
            
            container.innerHTML = currentSkills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <button type="button" onclick="removeSkill('${skill}')" class="text-gray-600 hover:text-black">√ó</button>
                </div>
            `).join('');
            
            hidden.value = JSON.stringify(currentSkills);
        }

        // Copy to clipboard
        function copyToClipboard() {
            const text = document.getElementById('proposal-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.add('show');
                setTimeout(() => feedback.classList.remove('show'), 2000);
            });
        }

        // Format links
        function formatLink(url) {
            try {
                const u = new URL(url);
                return u.hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        // Handle form submission
        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (currentSkills.length === 0) {
                alert('Please add at least one skill');
                return;
            }

            // Extract company name and job title from job description
            const jobDescription = document.getElementById('job_description').value;
            const companyMatch = jobDescription.match(/(?:company|client|organization)[\s:]+([^\n]+)/i);
            const company_name = companyMatch ? companyMatch[1].trim().substring(0, 50) : 'Client Company';
            
            const jobTitleMatch = jobDescription.match(/^(.+?)(?:\s*[-‚Äì]\s*|$)/);
            const job_title = jobTitleMatch ? jobTitleMatch[1].trim().substring(0, 50) : 'Project';

            const formData = {
                company_name: company_name,
                job_title: job_title,
                job_description: jobDescription,
                skills_required: currentSkills,
                industry: 'general',
                task_type: document.getElementById('task_type').value || 'other',
                proposal_style: 'professional',
                tone: 'confident',
                max_word_count: 150,
                similar_projects_count: 3,
                include_portfolio: true,
                include_feedback: true,
                include_previous_proposals: true
            };

            // Show loading
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('generate-btn').disabled = true;

            try {
                const response = await axios.post(`${API_BASE}/generate`, formData);
                const data = response.data;

                // Populate results
                document.getElementById('proposal-text').innerText = data.generated_proposal;
                document.getElementById('word-count').innerText = data.word_count;
                document.getElementById('quality-score').innerText = Math.round((data.confidence_score || 0.85) * 100);

                // Quality metrics
                const metrics = data.metadata?.quality_score_details || {};
                const metricsHtml = Object.entries(metrics)
                    .filter(([k]) => k !== 'overall_score' && k !== 'is_short_human_winning')
                    .map(([key, value]) => {
                        const percent = typeof value === 'number' ? Math.round(value * 100) : 0;
                        return `
                            <div class="quality-metric">
                                <span class="capitalize">${key.replace(/_/g, ' ')}</span>
                                <div class="quality-bar">
                                    <div class="quality-fill" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                document.getElementById('quality-metrics').innerHTML = metricsHtml || '<p class="text-gray-600 text-xs">Scoring...</p>';

                // Similar projects
                const projects = data.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length > 0
                    ? projects.map(p => `
                        <div class="p-3 bg-gray-50 rounded-6px">
                            <p class="font-600 text-black">${p.company}</p>
                            <p class="text-gray-600 text-xs mt-1">${p.title}</p>
                            <p class="text-gray-500 text-xs mt-1">${p.skills.slice(0, 3).join(', ')}</p>
                        </div>
                    `).join('')
                    : '<p class="text-gray-600 text-sm">No similar past projects found</p>';

                // Success patterns
                const insights = data.insights || {};
                const patterns = insights.success_patterns || [];
                document.getElementById('success-patterns').innerHTML = patterns.length > 0
                    ? patterns.map(p => `<div class="insight-badge">‚úì ${p}</div>`).join('')
                    : '<p class="text-gray-600 text-sm">None extracted</p>';

                // Portfolio links
                const portfolio = data.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = portfolio.length > 0
                    ? portfolio.map(link => `
                        <a href="${link}" target="_blank" class="text-blue-600 hover:underline text-sm">
                            üîó ${formatLink(link)}
                        </a>
                    `).join('')
                    : '<p class="text-gray-600 text-sm">None included</p>';

                // Show result
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');

            } catch (error) {
                alert('Error: ' + (error.response?.data?.detail || error.message));
            } finally {
                document.getElementById('generate-btn').disabled = false;
            }
        });

        // Allow Enter key in skill input
        document.getElementById('skill-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkills();
            }
        });
    </script>
</body>
</html>
