<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        body { 
            background: #fafafa;
            min-height: 100vh;
        }

        /* Input styling */
        .input-field {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 14px;
            transition: border-color 0.15s, box-shadow 0.15s;
            width: 100%;
        }
        
        .input-field:hover {
            border-color: #d4d4d4;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #171717;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
        }

        .input-field::placeholder {
            color: #a3a3a3;
        }

        /* Select */
        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Skill tags */
        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #171717;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .skill-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: #a3a3a3;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            margin-left: 2px;
        }

        .skill-tag button:hover {
            color: #fff;
        }

        /* Primary button */
        .btn-primary {
            background: #171717;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
        }

        .btn-primary:hover {
            background: #262626;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #a3a3a3;
            cursor: not-allowed;
        }

        /* Secondary button */
        .btn-secondary {
            background: #fff;
            color: #171717;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #d4d4d4;
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .toggle-container:hover {
            border-color: #d4d4d4;
        }

        .toggle-switch {
            width: 40px;
            height: 22px;
            background: #e5e5e5;
            border-radius: 11px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: #171717;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toggle-switch.active::after {
            transform: translateX(18px);
        }

        /* Loading */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e5e5;
            border-top-color: #171717;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Proposal card */
        .proposal-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
        }

        .proposal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .proposal-body {
            padding: 24px;
            font-size: 15px;
            line-height: 1.75;
            color: #404040;
            white-space: pre-wrap;
        }

        /* Stats */
        .stat-item {
            text-align: center;
            padding: 0 16px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #171717;
        }

        .stat-label {
            font-size: 12px;
            color: #737373;
            margin-top: 2px;
        }

        /* Copy feedback */
        .copy-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #171717;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        /* Info section */
        .info-section {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 20px;
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: #525252;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Project card */
        .project-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .project-item:last-child {
            margin-bottom: 0;
        }

        /* Link item */
        .link-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 6px;
            font-size: 13px;
            color: #525252;
            text-decoration: none;
            transition: background 0.15s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .link-item:hover {
            background: #f0f0f0;
            color: #171717;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-neutral-900">Proposal Generator</h1>
            </div>
            <a href="index.html" class="btn-secondary">
                ← Back
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid lg:grid-cols-5 gap-8">
            
            <!-- Left: Form (narrower) -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-neutral-200 rounded-xl p-6">
                    <h2 class="text-base font-semibold text-neutral-900 mb-6">Job Details</h2>
                    
                    <form id="proposal-form" class="space-y-5">
                        <!-- Task Type -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Task Type</label>
                            <select id="task_type" class="input-field" required>
                                <option value="">Select...</option>
                                <option value="complete website">Complete Website</option>
                                <option value="enhance functionality">Enhance Functionality</option>
                                <option value="redesign website">Redesign Website</option>
                                <option value="bug fixes">Bug Fixes</option>
                                <option value="speed optimization">Speed Optimization</option>
                                <option value="layout fixing">Layout Fixing</option>
                                <option value="seo">SEO</option>
                                <option value="consultation">Consultation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Skills -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Skills</label>
                            <div class="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    id="skill-input"
                                    placeholder="Add skills (comma separated)"
                                    class="input-field flex-1"
                                />
                                <button type="button" onclick="addSkills()" class="btn-secondary">Add</button>
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Job Description -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Description</label>
                            <textarea 
                                id="job_description"
                                placeholder="Paste the job description..."
                                rows="8"
                                class="input-field resize-none"
                                required
                            ></textarea>
                        </div>

                        <!-- Timeline Toggle -->
                        <div>
                            <div class="toggle-container" onclick="toggleTimeline()">
                                <div>
                                    <p class="text-sm font-medium text-neutral-700">Include Timeline</p>
                                    <p class="text-xs text-neutral-500 mt-0.5">Add delivery duration to proposal</p>
                                </div>
                                <div id="timeline-toggle" class="toggle-switch"></div>
                            </div>
                            <div id="timeline-input" class="hidden mt-3">
                                <input 
                                    type="text" 
                                    id="timeline_duration"
                                    placeholder="e.g., 2-3 weeks"
                                    class="input-field"
                                />
                            </div>
                        </div>

                        <!-- Submit -->
                        <button type="submit" id="generate-btn" class="btn-primary w-full">
                            Generate Proposal
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right: Output (wider) -->
            <div class="lg:col-span-3">
                <!-- Empty State -->
                <div id="empty-state" class="bg-white border border-neutral-200 rounded-xl p-12 text-center">
                    <p class="text-neutral-400 text-sm">Fill in the job details to generate a proposal</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden bg-white border border-neutral-200 rounded-xl p-12">
                    <div class="flex flex-col items-center">
                        <div class="loader mb-4"></div>
                        <p class="text-sm text-neutral-600">Generating proposal...</p>
                    </div>
                </div>

                <!-- Result State -->
                <div id="result-state" class="hidden space-y-6">
                    <!-- Proposal -->
                    <div class="proposal-card">
                        <div class="proposal-header">
                            <div class="flex items-center gap-6">
                                <div class="stat-item border-r border-neutral-200">
                                    <div class="stat-value" id="word-count">0</div>
                                    <div class="stat-label">words</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="quality-score">0%</div>
                                    <div class="stat-label">quality</div>
                                </div>
                            </div>
                            <button onclick="copyToClipboard()" class="btn-secondary relative">
                                Copy
                                <span class="copy-tooltip" id="copy-feedback">Copied!</span>
                            </button>
                        </div>
                        <div id="proposal-text" class="proposal-body"></div>
                    </div>

                    <!-- Similar Projects -->
                    <div class="info-section">
                        <div class="info-title">Similar Projects</div>
                        <div id="similar-projects">
                            <p class="text-sm text-neutral-500">None found</p>
                        </div>
                    </div>

                    <!-- Portfolio Links -->
                    <div class="info-section">
                        <div class="info-title">Portfolio References</div>
                        <div id="portfolio-links">
                            <p class="text-sm text-neutral-500">None included</p>
                        </div>
                    </div>

                    <!-- Reset -->
                    <button onclick="resetForm()" class="w-full py-3 text-sm text-neutral-500 hover:text-neutral-700 transition-colors">
                        Generate another proposal
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:8000/api/proposals';
        let currentSkills = [];
        let includeTimeline = false;

        function toggleTimeline() {
            includeTimeline = !includeTimeline;
            document.getElementById('timeline-toggle').classList.toggle('active', includeTimeline);
            document.getElementById('timeline-input').classList.toggle('hidden', !includeTimeline);
            if (!includeTimeline) {
                document.getElementById('timeline_duration').value = '';
            }
        }

        function addSkills() {
            const input = document.getElementById('skill-input');
            const text = input.value.trim();
            if (!text) return;
            
            const skills = text.split(',').map(s => s.trim()).filter(s => s && !currentSkills.includes(s));
            if (skills.length) {
                currentSkills.push(...skills);
                renderSkills();
                input.value = '';
                input.focus();
            }
        }

        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            renderSkills();
        }

        function renderSkills() {
            document.getElementById('skills-container').innerHTML = currentSkills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <button type="button" onclick="removeSkill('${skill}')">×</button>
                </div>
            `).join('');
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(document.getElementById('proposal-text').innerText).then(() => {
                const el = document.getElementById('copy-feedback');
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 1500);
            });
        }

        function formatLink(url) {
            try { return new URL(url).hostname.replace('www.', ''); } 
            catch { return url; }
        }

        function resetForm() {
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentSkills.length) {
                alert('Please add at least one skill');
                return;
            }

            const jobDesc = document.getElementById('job_description').value;
            const companyMatch = jobDesc.match(/(?:company|client|organization)[\s:]+([^\n]+)/i);
            const company = companyMatch ? companyMatch[1].trim().substring(0, 50) : 'Client';
            
            const titleMatch = jobDesc.match(/^(.+?)(?:\s*[-–]\s*|$)/);
            const title = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Project';

            const data = {
                company_name: company,
                job_title: title,
                job_description: jobDesc,
                skills_required: currentSkills,
                industry: 'general',
                task_type: document.getElementById('task_type').value || 'other',
                proposal_style: 'professional',
                tone: 'confident',
                max_word_count: 150,
                similar_projects_count: 3,
                include_portfolio: true,
                include_feedback: true,
                include_previous_proposals: true,
                include_timeline: includeTimeline,
                timeline_duration: document.getElementById('timeline_duration').value.trim() || null
            };

            // UI: Loading
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const res = await axios.post(`${API_BASE}/generate`, data);
                const result = res.data;

                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                // Similar projects
                const projects = result.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length
                    ? projects.map(p => `
                        <div class="project-item">
                            <p class="font-medium text-neutral-800 text-sm">${p.company}</p>
                            <p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' · ')}</p>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-neutral-500">None found</p>';

                // Portfolio
                const links = result.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = links.length
                    ? links.map(url => `<a href="${url}" target="_blank" class="link-item">${formatLink(url)}</a>`).join('')
                    : '<p class="text-sm text-neutral-500">None included</p>';

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');

            } catch (err) {
                alert('Error: ' + (err.response?.data?.detail || err.message));
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Proposal';
            }
        });

        document.getElementById('skill-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkills();
            }
        });
    </script>
</body>
</html>
