<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Training Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #ffffff; color: #1a1a1a; }
        input, textarea, select { font-family: 'Inter', sans-serif; }
        
        /* Enterprise minimalist theme */
        .form-input { 
            background: #f5f5f5; 
            border: 1px solid #e0e0e0; 
            transition: all 0.2s ease; 
        }
        .form-input:focus { 
            background: #ffffff; 
            border-color: #1a1a1a; 
            box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
        }
        
        /* Auto-save subtle indicator */
        .save-indicator { 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            background: #1a1a1a; 
            color: #ffffff; 
            padding: 10px 16px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 500; 
            letter-spacing: 0.3px; 
            opacity: 0; 
            transform: translateY(10px); 
            transition: all 0.3s ease; 
            pointer-events: none; 
            z-index: 40; 
        }
        .save-indicator.show { 
            opacity: 1; 
            transform: translateY(0); 
        }
        
        /* Skill tags - black & white minimalist */
        .skill-tag { 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            background: #f0f0f0; 
            border: 1px solid #d0d0d0; 
            padding: 7px 14px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 500; 
            letter-spacing: 0.2px; 
            transition: all 0.2s ease; 
        }
        .skill-tag:hover { 
            background: #e5e5e5; 
            border-color: #1a1a1a; 
        }
        .skill-tag button { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #666; 
            font-size: 16px; 
            padding: 0; 
            display: flex; 
            align-items: center; 
            line-height: 1; 
            transition: color 0.2s ease; 
        }
        .skill-tag button:hover { 
            color: #1a1a1a; 
        }
        
        /* Progress bar */
        .progress-container { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: #f0f0f0; 
            z-index: 50; 
        }
        .progress-bar { 
            height: 100%; 
            background: #1a1a1a; 
            width: 0%; 
            transition: width 0.3s ease; 
        }
        
        /* Progress modal */
        .progress-modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 60; 
        }
        .progress-modal.show { 
            display: flex; 
        }
        .progress-content { 
            background: white; 
            padding: 32px; 
            border-radius: 8px; 
            text-align: center; 
            max-width: 400px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
        }
        .progress-content h3 { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 16px; 
            letter-spacing: 0.3px; 
        }
        .progress-steps { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin: 24px 0; 
        }
        .progress-step { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 14px; 
            color: #666; 
        }
        .progress-step .step-icon { 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            background: #f0f0f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            font-weight: 600; 
            flex-shrink: 0; 
        }
        .progress-step.active .step-icon { 
            background: #1a1a1a; 
            color: white; 
        }
        .progress-step.done .step-icon { 
            background: #1a1a1a; 
            color: white; 
        }
        .spinner { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #e0e0e0; 
            border-top-color: #1a1a1a; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* Counter badge */
        .counter-badge { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 48px; 
            height: 48px; 
            background: #1a1a1a; 
            color: white; 
            border-radius: 6px; 
            font-size: 20px; 
            font-weight: 700; 
            letter-spacing: -0.5px; 
        }
        
        /* Image preview */
        .image-preview { 
            position: relative; 
            width: 100%; 
            max-width: 200px; 
            border-radius: 6px; 
            overflow: hidden; 
            background: #f5f5f5; 
        }
        .image-preview img { 
            width: 100%; 
            height: auto; 
            display: block; 
        }
        .image-preview .remove-btn { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: rgba(0,0,0,0.7); 
            color: white; 
            border: none; 
            width: 28px; 
            height: 28px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background 0.2s; 
        }
        .image-preview .remove-btn:hover { 
            background: rgba(0,0,0,0.9); 
        }
    </style>
</head>
<body>
    <!-- Progress bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <!-- Progress modal -->
    <div class="progress-modal" id="progress-modal">
        <div class="progress-content">
            <h3>Uploading Data</h3>
            <div class="progress-steps">
                <div class="progress-step active" id="step-store">
                    <div class="step-icon"><span class="spinner"></span></div>
                    <span>Storing data</span>
                </div>
                <div class="progress-step" id="step-chunks">
                    <div class="step-icon">2</div>
                    <span>Creating chunks</span>
                </div>
                <div class="progress-step" id="step-embeddings">
                    <div class="step-icon">3</div>
                    <span>Generating embeddings</span>
                </div>
                <div class="progress-step" id="step-pinecone">
                    <div class="step-icon">4</div>
                    <span>Saving vectors</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Save indicator -->
    <div class="save-indicator" id="save-indicator">✓ Saved</div>

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-8 py-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-700 tracking-tight text-black">Proposal Hub</h1>
                <p class="text-sm text-gray-500 mt-1 font-300 letter-spacing">AI Training Platform</p>
            </div>
            <div class="flex gap-8 items-center">
                <div class="text-right">
                    <div class="text-4xl font-700 tracking-tight text-black" id="total-trained">0</div>
                    <div class="text-xs text-gray-500 uppercase font-600 letter-spacing">Jobs Trained</div>
                </div>
                <div class="counter-badge" id="counter-badge">0</div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-8 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Form Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-8px border border-gray-200 p-10 space-y-8 shadow-sm">
                    <div>
                        <h2 class="text-2xl font-700 tracking-tight text-black mb-2">Add Proposal Data</h2>
                        <p class="text-sm text-gray-500 font-300">Complete information will be automatically saved</p>
                    </div>

                    <form id="proposal-form" class="space-y-7">
                        <!-- Basic Info -->
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Company Name *</label>
                                <input type="text" name="company_name" placeholder="TechCorp Inc" class="w-full px-4 py-3 form-input rounded-6px" required>
                            </div>
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Industry *</label>
                                <input type="text" name="industry" placeholder="SaaS, Finance, etc" class="w-full px-4 py-3 form-input rounded-6px" required>
                            </div>
                        </div>

                        <!-- Job Details -->
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Job Title *</label>
                                <input type="text" name="job_title" placeholder="Senior Backend Developer" class="w-full px-4 py-3 form-input rounded-6px" required>
                            </div>
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Task Type *</label>
                                <select name="task_type" class="w-full px-4 py-3 form-input rounded-6px" required onchange="handleTaskTypeChange()">
                                    <option value="">Select task type</option>
                                    <option value="development">Development</option>
                                    <option value="design">Design</option>
                                    <option value="writing">Writing</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="consulting">Consulting</option>
                                    <option value="support">Support</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Custom Task Type (hidden) -->
                        <div id="custom-task-group" class="hidden">
                            <label class="block text-sm font-600 text-black mb-3">Specify Task Type</label>
                            <input type="text" name="other_task_type" placeholder="e.g., Video Editing" class="w-full px-4 py-3 form-input rounded-6px">
                        </div>

                        <!-- Dates and Status -->
                        <div class="grid grid-cols-3 gap-5">
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Start Date</label>
                                <input type="date" name="start_date" class="w-full px-4 py-3 form-input rounded-6px">
                            </div>
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">End Date</label>
                                <input type="date" name="end_date" class="w-full px-4 py-3 form-input rounded-6px">
                            </div>
                            <div>
                                <label class="block text-sm font-600 text-black mb-3">Status *</label>
                                <select name="project_status" class="w-full px-4 py-3 form-input rounded-6px" required>
                                    <option value="">Select status</option>
                                    <option value="completed">Completed</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <!-- Urgent Flag -->
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="urgent_adhoc" class="w-4 h-4 rounded border-gray-300 cursor-pointer">
                            <span class="text-sm font-500 text-black">Urgent / Adhoc Project</span>
                        </label>

                        <!-- Skills -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-3">Skills Required * (Tab to add)</label>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="skill-input" placeholder="Type skill name and press Tab" class="flex-1 px-4 py-3 form-input rounded-6px">
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2">
                            </div>
                            <input type="hidden" name="skills_required" id="skills-hidden" value="[]">
                        </div>

                        <!-- Portfolio URLs -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-3">Portfolio Links</label>
                            <div class="flex gap-2 mb-3">
                                <input type="url" id="portfolio-input" placeholder="https://example.com" class="flex-1 px-4 py-3 form-input rounded-6px">
                                <button type="button" onclick="addPortfolio()" class="px-6 py-3 bg-black text-white rounded-6px font-600 text-sm hover:bg-gray-800 transition-all">Add</button>
                            </div>
                            <div id="portfolio-container" class="flex flex-wrap gap-2">
                            </div>
                            <input type="hidden" name="portfolio_urls" id="portfolio-hidden" value="[]">
                        </div>

                        <!-- Job Description -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-3">Job Description *</label>
                            <textarea name="job_description" placeholder="Describe the job requirements..." class="w-full px-4 py-3 form-input rounded-6px" rows="4" required></textarea>
                        </div>

                        <!-- Your Proposal -->
                        <div>
                            <label class="block text-sm font-600 text-black mb-3">Your Proposal *</label>
                            <textarea name="your_proposal_text" placeholder="Your proposal response..." class="w-full px-4 py-3 form-input rounded-6px" rows="4" required></textarea>
                        </div>

                        <!-- Feedback Section -->
                        <div class="border-t border-gray-200 pt-7">
                            <h3 class="text-sm font-600 text-black mb-4">Client Feedback (Optional)</h3>
                            
                            <!-- Feedback type toggle -->
                            <div class="flex gap-3 mb-5">
                                <button type="button" class="feedback-tab active px-4 py-2 text-sm font-600 border-b-2 border-black text-black" data-type="text">Text</button>
                                <button type="button" class="feedback-tab px-4 py-2 text-sm font-600 border-b-2 border-transparent text-gray-500 hover:text-black transition-colors" data-type="image">Image</button>
                            </div>

                            <!-- Text feedback -->
                            <div id="feedback-text-group">
                                <textarea name="client_feedback" id="feedback-text" placeholder="Paste or type feedback from client..." class="w-full px-4 py-3 form-input rounded-6px" rows="3"></textarea>
                            </div>

                            <!-- Image feedback -->
                            <div id="feedback-image-group" class="hidden">
                                <div class="border-2 border-dashed border-gray-300 rounded-6px p-6 text-center cursor-pointer hover:border-black transition-colors" id="feedback-drop-zone">
                                    <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <p class="text-sm font-500 text-gray-700">Drop image here or click to select</p>
                                    <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 5MB</p>
                                    <input type="file" id="feedback-image-input" accept="image/*" class="hidden">
                                </div>
                                <div id="image-preview-container" class="mt-4"></div>
                                <input type="hidden" name="feedback_image_path" id="feedback-image-hidden">
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-4 pt-6 border-t border-gray-200">
                            <button type="submit" class="flex-1 px-6 py-3 bg-black text-white rounded-6px font-700 text-sm hover:bg-gray-800 transition-all tracking-tight">Submit Entry</button>
                            <button type="reset" onclick="handleClearForm()" class="px-6 py-3 bg-gray-100 text-black rounded-6px font-600 text-sm hover:bg-gray-200 transition-all">Clear All</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black text-white rounded-6px p-5">
                        <div class="text-xs font-600 text-gray-300 mb-2 letter-spacing">Total</div>
                        <div class="text-3xl font-700 tracking-tight" id="stat-total">0</div>
                    </div>
                    <div class="bg-gray-100 text-black rounded-6px p-5">
                        <div class="text-xs font-600 text-gray-600 mb-2 letter-spacing">Chunks</div>
                        <div class="text-3xl font-700 tracking-tight" id="stat-chunks">0</div>
                    </div>
                </div>

                <!-- Recent Entries -->
                <div class="bg-white border border-gray-200 rounded-6px p-6">
                    <h3 class="text-sm font-700 tracking-tight text-black mb-4">Recent Entries</h3>
                    <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-xs text-gray-500 text-center py-8">No entries yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/job-data';
        let currentSkills = [];
        let currentPortfolios = [];
        let allHistory = [];
        let feedbackMode = 'text';
        let selectedImage = null;
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadFormData();
            loadStats();
            loadHistory();
            setupAutoSave();
            setupSkillInput();
            setupTaskTypeToggle();
            setupFeedbackTabs();
            setupImageUpload();
        });

        // === AUTO-SAVE SYSTEM ===
        function setupAutoSave() {
            const form = document.getElementById('proposal-form');
            form.addEventListener('change', () => {
                hasUnsavedChanges = true;
                clearAutoSaveTimer();
                autoSaveTimer = setTimeout(saveFormData, 1500);
            });
            form.addEventListener('input', () => {
                hasUnsavedChanges = true;
                clearAutoSaveTimer();
                autoSaveTimer = setTimeout(saveFormData, 1500);
            });
        }

        function clearAutoSaveTimer() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
        }

        function saveFormData() {
            if (!hasUnsavedChanges) return;
            
            const form = document.getElementById('proposal-form');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            data.skills_required = currentSkills;
            data.portfolio_urls = currentPortfolios;
            if (selectedImage) {
                data.feedback_image_path = selectedImage.name;
            }
            
            localStorage.setItem('proposal_form_draft', JSON.stringify(data));
            hasUnsavedChanges = false;
            showSaveIndicator();
        }

        function loadFormData() {
            const saved = localStorage.getItem('proposal_form_draft');
            if (saved) {
                const data = JSON.parse(saved);
                const form = document.getElementById('proposal-form');
                
                Object.keys(data).forEach(key => {
                    if (key !== 'skills_required' && key !== 'portfolio_urls' && key !== 'feedback_image_path') {
                        const field = form.elements[key];
                        if (field) {
                            if (field.type === 'checkbox') {
                                field.checked = data[key] === 'on' || data[key] === true;
                            } else {
                                field.value = data[key] || '';
                            }
                        }
                    }
                });

                if (data.skills_required && Array.isArray(data.skills_required)) {
                    currentSkills = data.skills_required;
                    updateSkillsDisplay();
                }

                if (data.portfolio_urls && Array.isArray(data.portfolio_urls)) {
                    currentPortfolios = data.portfolio_urls;
                    updatePortfolioDisplay();
                }
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // === SKILLS MANAGEMENT ===
        function setupSkillInput() {
            const input = document.getElementById('skill-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    addSkill();
                }
            });
        }

        function addSkill() {
            const input = document.getElementById('skill-input');
            const skill = input.value.trim();
            if (skill && !currentSkills.includes(skill)) {
                currentSkills.push(skill);
                updateSkillsDisplay();
                input.value = '';
                saveFormData();
            }
        }

        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            updateSkillsDisplay();
            saveFormData();
        }

        function updateSkillsDisplay() {
            const container = document.getElementById('skills-container');
            container.innerHTML = currentSkills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <button type="button" onclick="removeSkill('${skill}')">×</button>
                </div>
            `).join('');
            document.getElementById('skills-hidden').value = JSON.stringify(currentSkills);
        }

        // === PORTFOLIO MANAGEMENT ===
        function addPortfolio() {
            const input = document.getElementById('portfolio-input');
            const url = input.value.trim();
            if (url && !currentPortfolios.includes(url)) {
                try {
                    new URL(url);
                    currentPortfolios.push(url);
                    updatePortfolioDisplay();
                    input.value = '';
                    saveFormData();
                } catch {
                    alert('Invalid URL');
                }
            }
        }

        function removePortfolio(url) {
            currentPortfolios = currentPortfolios.filter(p => p !== url);
            updatePortfolioDisplay();
            saveFormData();
        }

        function updatePortfolioDisplay() {
            const container = document.getElementById('portfolio-container');
            container.innerHTML = currentPortfolios.map(url => `
                <div class="skill-tag">
                    <a href="${url}" target="_blank" class="text-black hover:underline">${new URL(url).hostname}</a>
                    <button type="button" onclick="removePortfolio('${url}')">×</button>
                </div>
            `).join('');
            document.getElementById('portfolio-hidden').value = JSON.stringify(currentPortfolios);
        }

        // === TASK TYPE TOGGLE ===
        function handleTaskTypeChange() {
            const select = document.querySelector('select[name="task_type"]');
            const group = document.getElementById('custom-task-group');
            if (select.value === 'other') {
                group.classList.remove('hidden');
            } else {
                group.classList.add('hidden');
                document.querySelector('input[name="other_task_type"]').value = '';
            }
        }

        // === FEEDBACK SYSTEM ===
        function setupFeedbackTabs() {
            const tabs = document.querySelectorAll('.feedback-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const type = tab.dataset.type;
                    feedbackMode = type;
                    
                    // Update tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update panels
                    document.getElementById('feedback-text-group').classList.toggle('hidden', type !== 'text');
                    document.getElementById('feedback-image-group').classList.toggle('hidden', type !== 'image');
                });
            });
        }

        function setupImageUpload() {
            const dropZone = document.getElementById('feedback-drop-zone');
            const input = document.getElementById('feedback-image-input');
            
            dropZone.addEventListener('click', () => input.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#1a1a1a';
                dropZone.style.background = '#f5f5f5';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '#d0d0d0';
                dropZone.style.background = '';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#d0d0d0';
                dropZone.style.background = '';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageSelect(files[0]);
                }
            });
            
            input.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageSelect(e.target.files[0]);
                }
            });
        }

        function handleImageSelect(file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('image-preview-container');
                preview.innerHTML = `
                    <div class="image-preview">
                        <img src="${e.target.result}" alt="Feedback image">
                        <button class="remove-btn" onclick="removeImage()">×</button>
                    </div>
                `;
                document.getElementById('feedback-image-hidden').value = file.name;
                saveFormData();
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            selectedImage = null;
            document.getElementById('feedback-image-input').value = '';
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('feedback-image-hidden').value = '';
            saveFormData();
        }

        // === CLEAR FORM ===
        function handleClearForm() {
            if (!confirm('Clear all form data?')) return;
            
            document.getElementById('proposal-form').reset();
            currentSkills = [];
            currentPortfolios = [];
            selectedImage = null;
            updateSkillsDisplay();
            updatePortfolioDisplay();
            document.getElementById('image-preview-container').innerHTML = '';
            document.getElementById('feedback-text').value = '';
            document.getElementById('skill-input').value = '';
            document.getElementById('portfolio-input').value = '';
            localStorage.removeItem('proposal_form_draft');
            saveFormData();
        }

        // === PROGRESS SYSTEM ===
        function showProgress() {
            document.getElementById('progress-modal').classList.add('show');
            document.getElementById('progress-bar').style.width = '20%';
        }

        function hideProgress() {
            document.getElementById('progress-modal').classList.remove('show');
            document.getElementById('progress-bar').style.width = '0%';
        }

        function updateProgress(step) {
            const steps = ['step-store', 'step-chunks', 'step-embeddings', 'step-pinecone'];
            const percentages = [20, 40, 70, 100];
            
            steps.forEach((s, idx) => {
                const el = document.getElementById(s);
                if (idx < step) {
                    el.classList.add('done');
                    el.classList.remove('active');
                    el.querySelector('.step-icon').innerHTML = '✓';
                } else if (idx === step) {
                    el.classList.add('active');
                    el.classList.remove('done');
                    el.querySelector('.step-icon').innerHTML = '<span class="spinner"></span>';
                } else {
                    el.classList.remove('active', 'done');
                    el.querySelector('.step-icon').innerHTML = (idx + 1);
                }
            });
            
            document.getElementById('progress-bar').style.width = percentages[step] + '%';
        }

        // === FORM SUBMISSION ===
        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (currentSkills.length === 0) {
                alert('Please add at least one skill');
                return;
            }

            const form = e.target;
            const formData = new FormData(form);
            
            // Build JSON object with proper type conversions
            const data = {
                company_name: formData.get('company_name'),
                industry: formData.get('industry'),
                job_title: formData.get('job_title'),
                task_type: formData.get('task_type'),
                start_date: formData.get('start_date') || null,
                end_date: formData.get('end_date') || null,
                project_status: formData.get('project_status'),
                urgent_adhoc: formData.get('urgent_adhoc') === 'on',
                job_description: formData.get('job_description'),
                your_proposal_text: formData.get('your_proposal_text'),
                client_feedback: formData.get('client_feedback') || null,
                skills_required: currentSkills,
                portfolio_urls: currentPortfolios
            };
            
            // Handle custom task type
            if (data.task_type === 'other') {
                const customType = formData.get('other_task_type');
                if (customType) {
                    data.task_type = customType;
                }
            }
            
            // Handle feedback type and image
            if (feedbackMode === 'image' && selectedImage) {
                data.feedback_type = 'image';
                data.feedback_image_path = selectedImage.name;
            } else if (data.client_feedback) {
                data.feedback_type = 'text';
            } else {
                data.feedback_type = null;
            }

            showProgress();

            try {
                updateProgress(0);
                
                // Send request as JSON
                const response = await axios.post(API_BASE + '/upload', data, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 201) {
                    updateProgress(3);
                    const result = response.data;
                    
                    // Add to history
                    allHistory.unshift({
                        contractId: result.contract_id,
                        company: data.company_name,
                        jobTitle: data.job_title,
                        chunks: result.data.chunks_created || 5,
                        timestamp: new Date().toLocaleString()
                    });

                    localStorage.setItem('proposal_history', JSON.stringify(allHistory));
                    updateStats();
                    loadHistory();

                    setTimeout(() => {
                        hideProgress();
                        alert(`✓ Success!\n\nContract: ${result.contract_id}\nChunks: ${result.data.chunks_created}\nEmbeddings: ${result.data.embeddings_created}`);
                        
                        form.reset();
                        currentSkills = [];
                        currentPortfolios = [];
                        selectedImage = null;
                        updateSkillsDisplay();
                        updatePortfolioDisplay();
                        document.getElementById('image-preview-container').innerHTML = '';
                        localStorage.removeItem('proposal_form_draft');
                    }, 500);
                }
            } catch (error) {
                hideProgress();
                const msg = error.response?.data?.detail || error.message;
                alert(`Error: ${msg}`);
            }
        });

        // === STATS AND HISTORY ===
        function loadHistory() {
            const saved = localStorage.getItem('proposal_history');
            allHistory = saved ? JSON.parse(saved) : [];

            const list = document.getElementById('history-list');
            if (allHistory.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-500 text-center py-8">No entries yet</p>';
                return;
            }

            list.innerHTML = allHistory.slice(0, 10).map(entry => `
                <div class="text-xs border-l-4 border-black pl-3 py-2.5 hover:bg-gray-50 transition-colors">
                    <div class="font-600 text-black">${entry.company}</div>
                    <div class="text-gray-600">${entry.jobTitle}</div>
                    <div class="text-gray-400 mt-1">${entry.timestamp}</div>
                </div>
            `).join('');
        }

        function loadStats() {
            const saved = localStorage.getItem('proposal_stats');
            const stats = saved ? JSON.parse(saved) : { total: 0, chunks: 0 };
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-chunks').textContent = stats.chunks;
            document.getElementById('total-trained').textContent = stats.total;
            document.getElementById('counter-badge').textContent = stats.total;
        }

        function updateStats() {
            const saved = localStorage.getItem('proposal_stats');
            const stats = saved ? JSON.parse(saved) : { total: 0, chunks: 0 };
            stats.total += 1;
            stats.chunks += 5;
            localStorage.setItem('proposal_stats', JSON.stringify(stats));
            loadStats();
        }
    </script>
</body>
</html>