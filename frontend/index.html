<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="image.png">
    <title>Proposal Generator | AI-Powered Upwork Proposals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #fafafa; min-height: 100vh; }
        .input-field { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px 14px; font-size: 14px; transition: all 0.15s; width: 100%; }
        .input-field:focus { outline: none; border-color: #171717; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        select.input-field { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
        .skill-tag { display: inline-flex; align-items: center; gap: 6px; background: #171717; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; }
        .skill-tag button { background: none; border: none; cursor: pointer; color: #a3a3a3; font-size: 14px; padding: 0; }
        .skill-tag button:hover { color: #fff; }
        .btn-primary { background: #171717; color: #fff; border: none; border-radius: 8px; padding: 14px 20px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.15s; }
        .btn-primary:hover { background: #262626; }
        .btn-primary:disabled { background: #a3a3a3; cursor: not-allowed; }
        .btn-secondary { background: #fff; color: #171717; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-secondary:hover { background: #fafafa; border-color: #d4d4d4; }
        .toggle-container { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; cursor: pointer; }
        .toggle-switch { width: 40px; height: 22px; background: #e5e5e5; border-radius: 11px; position: relative; transition: background 0.2s; }
        .toggle-switch.active { background: #171717; }
        .toggle-switch::after { content: ''; position: absolute; width: 18px; height: 18px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .toggle-switch.active::after { transform: translateX(18px); }
        .loader { width: 20px; height: 20px; border: 2px solid #e5e5e5; border-top-color: #171717; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .proposal-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 12px; overflow: hidden; }
        .proposal-header { padding: 20px 24px; border-bottom: 1px solid #e5e5e5; display: flex; align-items: center; justify-content: space-between; }
        .proposal-body { padding: 24px; font-size: 15px; line-height: 1.75; color: #404040; white-space: pre-wrap; }
        .stat-item { text-align: center; padding: 0 16px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #171717; }
        .stat-label { font-size: 12px; color: #737373; margin-top: 2px; }
        .info-section { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px; }
        .info-title { font-size: 13px; font-weight: 600; color: #525252; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .project-item { padding: 12px; background: #fafafa; border-radius: 8px; margin-bottom: 8px; }
        .project-item:last-child { margin-bottom: 0; }
        .link-item { display: inline-flex; padding: 8px 12px; background: #fafafa; border-radius: 6px; font-size: 13px; color: #525252; text-decoration: none; margin-right: 8px; margin-bottom: 8px; }
        .link-item:hover { background: #f0f0f0; color: #171717; }
        .action-btn { display: inline-flex; align-items: center; gap: 5px; background: transparent; color: #737373; border: none; padding: 6px 10px; font-weight: 500; font-size: 13px; cursor: pointer; }
        .action-btn:hover { color: #171717; }
        .action-btn.action-btn-primary { background: #171717; color: #fff; border-radius: 6px; padding: 6px 12px; }
        .action-btn.action-btn-primary:hover { background: #262626; }
        .proposal-body-editable { padding: 24px; font-size: 15px; line-height: 1.75; color: #171717; white-space: pre-wrap; min-height: 200px; border-left: 2px solid #171717; background: #fafafa; outline: none; }
        .proposal-body-editable:focus { background: #fff; }
        .edit-mode-banner { background: #fafafa; border-bottom: 1px solid #e5e5e5; padding: 8px 24px; display: flex; align-items: center; justify-content: space-between; }
        .edit-mode-banner p { font-size: 12px; color: #737373; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #171717; color: #fff; padding: 12px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; opacity: 0; transform: translateY(8px); transition: all 0.2s; z-index: 100; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-overlay.hidden { display: none; }
        .auth-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 360px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .nav-link { display: none; }
        .nav-link.visible { display: inline-flex; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-modal">
            <div class="text-center mb-6">
                <h1 class="text-xl font-semibold text-neutral-900">Proposal Generator</h1>
                <p class="text-sm text-neutral-500 mt-1">Enter your API key to continue</p>
            </div>
            <form onsubmit="authenticate(event)">
                <input type="password" id="api-key-input" class="input-field mb-3" placeholder="Enter API Key" required>
                <label class="flex items-center gap-2 mb-4 text-xs text-neutral-500 cursor-pointer">
                    <input type="checkbox" id="remember-key" checked class="accent-neutral-900"> Remember me
                </label>
                <button type="submit" class="btn-primary w-full" id="auth-btn">Continue</button>
                <p class="text-xs text-red-500 text-center mt-3 min-h-[16px]" id="auth-error"></p>
            </form>
        </div>
    </div>

    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-neutral-900">Proposal Generator</h1>
                <p class="text-xs text-neutral-500">AI-powered winning proposals</p>
            </div>
            <div class="flex items-center gap-3" id="nav-links">
                <a href="dashboard.html" class="btn-secondary nav-link" id="nav-dashboard">Dashboard</a>
                <a href="history.html" class="btn-secondary nav-link" id="nav-history">History</a>
                <a href="training.html" class="btn-secondary nav-link" id="nav-training">Training</a>
                <a href="admin.html" class="btn-secondary nav-link" id="nav-admin">Admin</a>
                <button onclick="logout()" class="btn-secondary" id="logout-btn" style="display:none">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid lg:grid-cols-5 gap-8">
            <!-- Left: Form -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-neutral-200 rounded-xl p-6">
                    <h2 class="text-base font-semibold text-neutral-900 mb-6">Job Details</h2>
                    <form id="proposal-form" class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Skills</label>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="skill-input" placeholder="Add skills (comma separated)" class="input-field flex-1">
                                <button type="button" onclick="addSkills()" class="btn-secondary">Add</button>
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Description</label>
                            <textarea id="job_description" placeholder="Paste the job description..." rows="8" class="input-field resize-none" required></textarea>
                        </div>
                        <div>
                            <div class="toggle-container" onclick="toggleTimeline()">
                                <div>
                                    <p class="text-sm font-medium text-neutral-700">Include Timeline</p>
                                    <p class="text-xs text-neutral-500 mt-0.5">Add delivery duration to proposal</p>
                                </div>
                                <div id="timeline-toggle" class="toggle-switch"></div>
                            </div>
                            <div id="timeline-input" class="hidden mt-3">
                                <input type="text" id="timeline_duration" placeholder="e.g., 2-3 weeks" class="input-field">
                            </div>
                        </div>
                        <button type="submit" id="generate-btn" class="btn-primary w-full">Generate Proposal</button>
                    </form>
                </div>
            </div>

            <!-- Right: Output -->
            <div class="lg:col-span-3">
                <div id="empty-state" class="bg-white border border-neutral-200 rounded-xl p-12 text-center">
                    <p class="text-neutral-400 text-sm">Fill in the job details to generate a proposal</p>
                </div>
                <div id="loading-state" class="hidden bg-white border border-neutral-200 rounded-xl p-12">
                    <div class="flex flex-col items-center">
                        <div class="loader mb-4"></div>
                        <p class="text-sm text-neutral-600">Generating proposal...</p>
                    </div>
                </div>
                <div id="result-state" class="hidden space-y-6">
                    <div class="proposal-card">
                        <div class="proposal-header">
                            <div class="flex items-center gap-6">
                                <div class="stat-item border-r border-neutral-200">
                                    <div class="stat-value" id="word-count">0</div>
                                    <div class="stat-label">words</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="quality-score">0%</div>
                                    <div class="stat-label">quality</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="toggleEditMode()" id="edit-btn" class="action-btn"><span id="edit-btn-text">Edit</span></button>
                                <span class="text-neutral-300">|</span>
                                <button onclick="copyToClipboard()" class="action-btn">Copy</button>
                                <span class="text-neutral-300">|</span>
                                <button onclick="saveAndSend()" id="save-send-btn" class="action-btn action-btn-primary">ðŸ“¤ Save & Send</button>
                            </div>
                        </div>
                        <div id="edit-mode-banner" class="edit-mode-banner hidden">
                            <p>Editing mode â€” click outside or press Escape to finish</p>
                            <div class="flex gap-2">
                                <button onclick="cancelEdit()" class="action-btn text-xs">Discard</button>
                                <button onclick="saveEdit()" class="action-btn action-btn-primary text-xs">Done</button>
                            </div>
                        </div>
                        <div id="proposal-text" class="proposal-body"></div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 px-1">
                        <span class="text-xs text-neutral-400">Adjust:</span>
                        <button onclick="quickTweak('shorter')" class="text-xs text-neutral-500 hover:text-neutral-900">Shorter</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('friendlier')" class="text-xs text-neutral-500 hover:text-neutral-900">Friendlier</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('technical')" class="text-xs text-neutral-500 hover:text-neutral-900">Technical</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('confident')" class="text-xs text-neutral-500 hover:text-neutral-900">Confident</button>
                    </div>
                    <div class="info-section">
                        <div class="info-title">Similar Projects</div>
                        <div id="similar-projects"><p class="text-sm text-neutral-500">None found</p></div>
                    </div>
                    <div class="info-section">
                        <div class="info-title">Portfolio References</div>
                        <div id="portfolio-links"><p class="text-sm text-neutral-500">None included</p></div>
                    </div>
                    <button onclick="resetForm()" class="w-full py-2 text-xs text-neutral-400 hover:text-neutral-600">Start over</button>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        const API = 'https://ml.genproposals.com/api';
        const KEY_NAME = 'app_api_key';
        let apiKey = localStorage.getItem(KEY_NAME) || '';
        let userRole = null;
        let currentSkills = [], includeTimeline = false, isEditMode = false, originalProposalText = '';
        let lastRequestData = null, lastGeneratedResult = null, proposalSaved = false;

        axios.interceptors.request.use(c => { if (apiKey) c.headers['X-API-Key'] = apiKey; return c; });
        axios.interceptors.response.use(r => r, e => { if ([401, 403].includes(e.response?.status)) { showAuth(); } return Promise.reject(e); });

        document.addEventListener('DOMContentLoaded', () => apiKey ? verifyAndLoad() : showAuth());

        function showAuth() { document.getElementById('auth-overlay').classList.remove('hidden'); document.getElementById('api-key-input').focus(); }
        function hideAuth() { document.getElementById('auth-overlay').classList.add('hidden'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show'; setTimeout(() => t.classList.remove('show'), 2000); }

        async function verifyAndLoad() {
            try {
                const { data } = await axios.get(`${API}/auth/verify`);
                userRole = data.role;
                hideAuth();
                updateNav();
                document.getElementById('logout-btn').style.display = 'block';
            } catch { apiKey = ''; localStorage.removeItem(KEY_NAME); showAuth(); }
        }

        async function authenticate(e) {
            e.preventDefault();
            const btn = document.getElementById('auth-btn'), err = document.getElementById('auth-error');
            apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) { err.textContent = 'Enter API key'; return; }
            btn.disabled = true; btn.textContent = 'Verifying...'; err.textContent = '';
            try {
                const { data } = await axios.get(`${API}/auth/verify`);
                userRole = data.role;
                if (document.getElementById('remember-key').checked) localStorage.setItem(KEY_NAME, apiKey);
                hideAuth();
                updateNav();
                document.getElementById('logout-btn').style.display = 'block';
            } catch { err.textContent = 'Invalid API key'; apiKey = ''; }
            btn.disabled = false; btn.textContent = 'Continue';
        }

        function updateNav() {
            // Super Admin: all links | Admin: Dashboard, History, Training | User: none
            const isSuper = userRole === 'super_admin';
            const isAdmin = userRole === 'admin' || isSuper;
            document.getElementById('nav-dashboard').classList.toggle('visible', isAdmin);
            document.getElementById('nav-history').classList.toggle('visible', isAdmin);
            document.getElementById('nav-training').classList.toggle('visible', isAdmin);
            document.getElementById('nav-admin').classList.toggle('visible', isSuper);
        }

        function logout() { apiKey = ''; userRole = null; localStorage.removeItem(KEY_NAME); location.reload(); }

        function toggleTimeline() {
            includeTimeline = !includeTimeline;
            document.getElementById('timeline-toggle').classList.toggle('active', includeTimeline);
            document.getElementById('timeline-input').classList.toggle('hidden', !includeTimeline);
        }

        function addSkills() {
            const input = document.getElementById('skill-input');
            const skills = input.value.split(',').map(s => s.trim()).filter(s => s && !currentSkills.includes(s));
            if (skills.length) { currentSkills.push(...skills); renderSkills(); input.value = ''; }
        }

        function removeSkill(skill) { currentSkills = currentSkills.filter(s => s !== skill); renderSkills(); }
        function renderSkills() { document.getElementById('skills-container').innerHTML = currentSkills.map(s => `<div class="skill-tag">${s}<button onclick="removeSkill('${s}')">Ã—</button></div>`).join(''); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('proposal-text').innerText).then(() => showToast('Copied')); }
        function formatLink(url) { try { return new URL(url).hostname.replace('www.', ''); } catch { return url; } }

        async function saveAndSend() {
            if (!lastGeneratedResult || !lastRequestData) { showToast('Generate a proposal first'); return; }
            if (proposalSaved) { showToast('Already saved!'); return; }
            const btn = document.getElementById('save-send-btn');
            btn.disabled = true; btn.innerHTML = 'Saving...';
            try {
                const proposalText = document.getElementById('proposal-text').innerText;
                await axios.post(`${API}/proposals/save`, {
                    job_title: lastRequestData.job_title, company_name: lastRequestData.company_name,
                    job_description: lastRequestData.job_description, proposal_text: proposalText,
                    skills_required: lastRequestData.skills_required, industry: lastRequestData.industry || 'general',
                    task_type: lastRequestData.task_type || 'other',
                    word_count: proposalText.trim().split(/\s+/).filter(w => w).length,
                    similar_projects_used: (lastGeneratedResult.similar_projects || []).map(p => p.contract_id).filter(Boolean),
                    portfolio_links_used: lastGeneratedResult.portfolio_links_used || [],
                    confidence_score: lastGeneratedResult.confidence_score || 0, source: 'ai_generated'
                });
                proposalSaved = true; btn.innerHTML = 'âœ“ Saved'; btn.classList.remove('action-btn-primary'); btn.style.background = '#059669';
                showToast('Saved!');
            } catch (err) { showToast('Error saving'); btn.disabled = false; btn.innerHTML = 'ðŸ“¤ Save & Send'; }
        }

        function resetForm() {
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            isEditMode = false; originalProposalText = ''; proposalSaved = false; lastGeneratedResult = null;
            const saveBtn = document.getElementById('save-send-btn');
            saveBtn.innerHTML = 'ðŸ“¤ Save & Send'; saveBtn.disabled = false; saveBtn.style.background = ''; saveBtn.classList.add('action-btn-primary');
        }

        function toggleEditMode() {
            const el = document.getElementById('proposal-text'), btn = document.getElementById('edit-btn-text'), banner = document.getElementById('edit-mode-banner');
            if (!isEditMode) {
                isEditMode = true; originalProposalText = el.innerText;
                el.setAttribute('contenteditable', 'true'); el.classList.remove('proposal-body'); el.classList.add('proposal-body-editable'); el.focus();
                btn.textContent = 'Editing...'; document.getElementById('edit-btn').classList.add('action-btn-primary'); banner.classList.remove('hidden');
            } else { saveEdit(); }
        }

        function saveEdit() {
            const el = document.getElementById('proposal-text'), btn = document.getElementById('edit-btn-text'), banner = document.getElementById('edit-mode-banner');
            isEditMode = false; el.setAttribute('contenteditable', 'false'); el.classList.remove('proposal-body-editable'); el.classList.add('proposal-body');
            btn.textContent = 'Edit'; document.getElementById('edit-btn').classList.remove('action-btn-primary'); banner.classList.add('hidden');
            document.getElementById('word-count').textContent = el.innerText.trim().split(/\s+/).filter(w => w).length;
            showToast('Saved');
        }

        function cancelEdit() {
            const el = document.getElementById('proposal-text');
            isEditMode = false; el.innerText = originalProposalText;
            el.setAttribute('contenteditable', 'false'); el.classList.remove('proposal-body-editable'); el.classList.add('proposal-body');
            document.getElementById('edit-btn-text').textContent = 'Edit';
            document.getElementById('edit-btn').classList.remove('action-btn-primary');
            document.getElementById('edit-mode-banner').classList.add('hidden');
        }

        async function quickTweak(type) {
            if (!lastRequestData) { showToast('Generate first'); return; }
            const data = { ...lastRequestData };
            if (type === 'shorter') data.max_word_count = Math.max(100, (data.max_word_count || 150) - 50);
            else if (type === 'friendlier') { data.tone = 'friendly'; data.proposal_style = 'casual'; }
            else if (type === 'technical') { data.proposal_style = 'technical'; data.tone = 'analytical'; }
            else if (type === 'confident') data.tone = 'confident';
            showToast('Adjusting...');
            try {
                const { data: result } = await axios.post(`${API}/proposals/generate`, data);
                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';
                showToast('Done');
            } catch { showToast('Error'); }
        }

        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentSkills.length) { alert('Add at least one skill'); return; }
            const jobDesc = document.getElementById('job_description').value;
            const data = {
                company_name: (jobDesc.match(/(?:company|client)[\s:]+([^\n]+)/i)?.[1] || 'Client').substring(0, 50),
                job_title: (jobDesc.match(/^(.+?)(?:\s*[-â€“]\s*|$)/)?.[1] || 'Project').substring(0, 50),
                job_description: jobDesc, skills_required: currentSkills, industry: 'general', task_type: 'auto',
                proposal_style: 'professional', tone: 'confident', max_word_count: 150, similar_projects_count: 3,
                include_portfolio: true, include_feedback: true, include_previous_proposals: true,
                include_timeline: includeTimeline, timeline_duration: document.getElementById('timeline_duration').value.trim() || null
            };
            lastRequestData = data;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            const btn = document.getElementById('generate-btn');
            btn.disabled = true; btn.innerHTML = '<div class="loader mx-auto"></div>';
            try {
                const { data: result } = await axios.post(`${API}/proposals/generate`, data);
                lastGeneratedResult = result; proposalSaved = false;
                const saveBtn = document.getElementById('save-send-btn');
                saveBtn.innerHTML = 'ðŸ“¤ Save & Send'; saveBtn.disabled = false; saveBtn.style.background = ''; saveBtn.classList.add('action-btn-primary');
                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';
                const projects = result.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length
                    ? projects.map(p => `<div class="project-item"><p class="font-medium text-neutral-800 text-sm">${p.company}</p><p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' Â· ')}</p></div>`).join('')
                    : '<p class="text-sm text-neutral-500">None found</p>';
                const links = result.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = links.length
                    ? links.map(url => `<a href="${url}" target="_blank" class="link-item">${formatLink(url)}</a>`).join('')
                    : '<p class="text-sm text-neutral-500">None included</p>';
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');
            } catch (err) { alert('Error: ' + (err.response?.data?.detail || err.message)); document.getElementById('loading-state').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); }
            finally { btn.disabled = false; btn.innerHTML = 'Generate Proposal'; }
        });

        document.getElementById('skill-input').addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); addSkills(); } });
    </script>
</body>
</html>
