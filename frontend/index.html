<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="image.png" >
    <!-- Disable caching for development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Proposal Generator | AI-Powered Upwork Proposals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        body { 
            background: #fafafa;
            min-height: 100vh;
        }

        /* Input styling */
        .input-field {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 14px;
            transition: border-color 0.15s, box-shadow 0.15s;
            width: 100%;
        }
        
        .input-field:hover {
            border-color: #d4d4d4;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #171717;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
        }

        .input-field::placeholder {
            color: #a3a3a3;
        }

        /* Select */
        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Skill tags */
        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #171717;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .skill-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: #a3a3a3;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            margin-left: 2px;
        }

        .skill-tag button:hover {
            color: #fff;
        }

        /* Primary button */
        .btn-primary {
            background: #171717;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
        }

        .btn-primary:hover {
            background: #262626;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #a3a3a3;
            cursor: not-allowed;
        }

        /* Secondary button */
        .btn-secondary {
            background: #fff;
            color: #171717;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #d4d4d4;
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .toggle-container:hover {
            border-color: #d4d4d4;
        }

        .toggle-switch {
            width: 40px;
            height: 22px;
            background: #e5e5e5;
            border-radius: 11px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: #171717;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toggle-switch.active::after {
            transform: translateX(18px);
        }

        /* Loading */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e5e5;
            border-top-color: #171717;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Proposal card */
        .proposal-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
        }

        .proposal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .proposal-body {
            padding: 24px;
            font-size: 15px;
            line-height: 1.75;
            color: #404040;
            white-space: pre-wrap;
        }

        /* Stats */
        .stat-item {
            text-align: center;
            padding: 0 16px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #171717;
        }

        .stat-label {
            font-size: 12px;
            color: #737373;
            margin-top: 2px;
        }

        /* Copy feedback */
        .copy-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #171717;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        /* Info section */
        .info-section {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 20px;
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: #525252;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Project card */
        .project-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .project-item:last-child {
            margin-bottom: 0;
        }

        /* Link item */
        .link-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 6px;
            font-size: 13px;
            color: #525252;
            text-decoration: none;
            transition: background 0.15s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .link-item:hover {
            background: #f0f0f0;
            color: #171717;
        }

        /* Action buttons group */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: transparent;
            color: #737373;
            border: none;
            padding: 6px 10px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.15s;
        }

        .action-btn:hover {
            color: #171717;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-btn svg {
            width: 15px;
            height: 15px;
        }

        .action-btn.action-btn-primary {
            background: #171717;
            color: #fff;
            border-radius: 6px;
            padding: 6px 12px;
        }

        .action-btn.action-btn-primary:hover {
            background: #262626;
        }

        /* Editable proposal */
        .proposal-body-editable {
            padding: 24px;
            font-size: 15px;
            line-height: 1.75;
            color: #171717;
            white-space: pre-wrap;
            min-height: 200px;
            border-left: 2px solid #171717;
            margin: 0;
            background: #fafafa;
            outline: none;
        }

        .proposal-body-editable:focus {
            background: #fff;
        }

        /* Edit mode indicator */
        .edit-mode-banner {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            padding: 8px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .edit-mode-banner p {
            font-size: 12px;
            color: #737373;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #171717;
            color: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-neutral-900">Proposal Generator</h1>
                <p class="text-xs text-neutral-500">AI-powered winning proposals</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="history.html" class="btn-secondary inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    History
                </a>
                <a href="training.html" class="btn-secondary inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    Training
                </a>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid lg:grid-cols-5 gap-8">
            
            <!-- Left: Form (narrower) -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-neutral-200 rounded-xl p-6">
                    <h2 class="text-base font-semibold text-neutral-900 mb-6">Job Details</h2>
                    
                    <form id="proposal-form" class="space-y-5">
                        <!-- Task Type -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Task Type</label>
                            <select id="task_type" class="input-field" required>
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <!-- Skills -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Skills</label>
                            <div class="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    id="skill-input"
                                    placeholder="Add skills (comma separated)"
                                    class="input-field flex-1"
                                />
                                <button type="button" onclick="addSkills()" class="btn-secondary">Add</button>
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Job Description -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Description</label>
                            <textarea 
                                id="job_description"
                                placeholder="Paste the job description..."
                                rows="8"
                                class="input-field resize-none"
                                required
                            ></textarea>
                        </div>

                        <!-- Timeline Toggle -->
                        <div>
                            <div class="toggle-container" onclick="toggleTimeline()">
                                <div>
                                    <p class="text-sm font-medium text-neutral-700">Include Timeline</p>
                                    <p class="text-xs text-neutral-500 mt-0.5">Add delivery duration to proposal</p>
                                </div>
                                <div id="timeline-toggle" class="toggle-switch"></div>
                            </div>
                            <div id="timeline-input" class="hidden mt-3">
                                <input 
                                    type="text" 
                                    id="timeline_duration"
                                    placeholder="e.g., 2-3 weeks"
                                    class="input-field"
                                />
                            </div>
                        </div>

                        <!-- Submit -->
                        <button type="submit" id="generate-btn" class="btn-primary w-full">
                            Generate Proposal
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right: Output (wider) -->
            <div class="lg:col-span-3">
                <!-- Empty State -->
                <div id="empty-state" class="bg-white border border-neutral-200 rounded-xl p-12 text-center">
                    <p class="text-neutral-400 text-sm">Fill in the job details to generate a proposal</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden bg-white border border-neutral-200 rounded-xl p-12">
                    <div class="flex flex-col items-center">
                        <div class="loader mb-4"></div>
                        <p class="text-sm text-neutral-600">Generating proposal...</p>
                    </div>
                </div>

                <!-- Result State -->
                <div id="result-state" class="hidden space-y-6">
                    <!-- Proposal -->
                    <div class="proposal-card">
                        <div class="proposal-header">
                            <div class="flex items-center gap-6">
                                <div class="stat-item border-r border-neutral-200">
                                    <div class="stat-value" id="word-count">0</div>
                                    <div class="stat-label">words</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="quality-score">0%</div>
                                    <div class="stat-label">quality</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="toggleEditMode()" id="edit-btn" class="action-btn" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zM16.862 4.487L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                    </svg>
                                    <span id="edit-btn-text">Edit</span>
                                </button>
                                <span class="text-neutral-300">|</span>
                                <button onclick="copyToClipboard()" class="action-btn" title="Copy">
                                    Copy
                                </button>
                                <span class="text-neutral-300">|</span>
                                <button onclick="saveAndSend()" id="save-send-btn" class="action-btn action-btn-primary" title="Save & Track">
                                    ðŸ“¤ Save & Send
                                </button>
                            </div>
                        </div>
                        
                        <!-- Edit mode banner (hidden by default) -->
                        <div id="edit-mode-banner" class="edit-mode-banner hidden">
                            <p>Editing mode â€” click outside or press Escape to finish</p>
                            <div class="flex gap-2">
                                <button onclick="cancelEdit()" class="action-btn text-xs">Discard</button>
                                <button onclick="saveEdit()" class="action-btn action-btn-primary text-xs">Done</button>
                            </div>
                        </div>
                        
                        <div id="proposal-text" class="proposal-body"></div>
                    </div>

                    <!-- Temporary Link Input -->
                    <div class="info-section" style="padding: 12px 16px;">
                        <div class="flex items-center gap-3">
                            <label class="text-xs font-medium text-neutral-600 whitespace-nowrap">Temporary Link</label>
                            <input 
                                type="url" 
                                id="temporary-link-input"
                                placeholder="https://upwork.com/job/... (optional)"
                                class="input-field text-sm"
                                style="padding: 8px 12px;"
                            />
                        </div>
                        <p class="text-xs text-neutral-400 mt-1">Add a URL to reference later (e.g., job posting link)</p>
                    </div>

                    <!-- Quick Adjustments -->
                    <div class="flex flex-wrap items-center gap-2 px-1">
                        <span class="text-xs text-neutral-400">Adjust:</span>
                        <button onclick="quickTweak('shorter')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Shorter</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('friendlier')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Friendlier</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('technical')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Technical</button>
                        <span class="text-neutral-300">Â·</span>
                        <button onclick="quickTweak('confident')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Confident</button>
                    </div>

                    <!-- Similar Projects -->
                    <div class="info-section">
                        <div class="info-title">Similar Projects</div>
                        <div id="similar-projects">
                            <p class="text-sm text-neutral-500">None found</p>
                        </div>
                    </div>

                    <!-- Portfolio Links -->
                    <div class="info-section">
                        <div class="info-title">Portfolio References</div>
                        <div id="portfolio-links">
                            <p class="text-sm text-neutral-500">None included</p>
                        </div>
                    </div>

                    <!-- Start Fresh -->
                    <button onclick="resetForm()" class="w-full py-2 text-xs text-neutral-400 hover:text-neutral-600 transition-colors">
                        Start over
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <script>
        // CHANGE THIS TO TEST LOCALLY vs PRODUCTION
        // Local: 'http://127.0.0.1:8000/api/proposals'
        // Production: 'https://ml.genproposals.com/api/proposals'
        const API_BASE = 'https://ml.genproposals.com/api/proposals';
        const API_JOB_DATA_BASE = 'https://ml.genproposals.com/api/job-data';
        
        let currentSkills = [];
        let includeTimeline = false;
        let isEditMode = false;
        let originalProposalText = '';
        let lastRequestData = null;
        let lastGeneratedResult = null;  // Store full result for saving
        let proposalSaved = false;  // Track if current proposal was saved

        // Load task types from database on page load
        document.addEventListener('DOMContentLoaded', loadTaskTypes);

        // Fetch task types from database
        async function loadTaskTypes() {
            const taskSelect = document.getElementById('task_type');
            try {
                const response = await axios.get(`${API_JOB_DATA_BASE}/stats/filter-options`);
                const { task_types } = response.data;
                
                // Default task types to always include
                const defaultTaskTypes = [
                    'complete website', 'enhance functionality', 'redesign website',
                    'bug fixes', 'speed optimization', 'layout fixing', 'seo',
                    'consultation', 'ai_ml', 'backend_api', 'frontend', 'mobile_app'
                ];
                
                // Merge database task types with defaults, remove duplicates, sort
                const allTaskTypes = [...new Set([...defaultTaskTypes, ...task_types])].sort();
                
                // Format display name (capitalize, replace underscores)
                const formatName = (t) => t.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                
                taskSelect.innerHTML = '<option value="">Select...</option>' + 
                    allTaskTypes.map(t => `<option value="${t}">${formatName(t)}</option>`).join('') +
                    '<option value="other">Other</option>';
                    
            } catch (e) {
                console.error('Error loading task types:', e);
                // Fallback to default options
                taskSelect.innerHTML = `
                    <option value="">Select...</option>
                    <option value="complete website">Complete Website</option>
                    <option value="enhance functionality">Enhance Functionality</option>
                    <option value="redesign website">Redesign Website</option>
                    <option value="bug fixes">Bug Fixes</option>
                    <option value="speed optimization">Speed Optimization</option>
                    <option value="layout fixing">Layout Fixing</option>
                    <option value="seo">SEO</option>
                    <option value="consultation">Consultation</option>
                    <option value="ai_ml">AI/ML</option>
                    <option value="backend_api">Backend API</option>
                    <option value="other">Other</option>
                `;
            }
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function toggleTimeline() {
            includeTimeline = !includeTimeline;
            document.getElementById('timeline-toggle').classList.toggle('active', includeTimeline);
            document.getElementById('timeline-input').classList.toggle('hidden', !includeTimeline);
            if (!includeTimeline) {
                document.getElementById('timeline_duration').value = '';
            }
        }

        function addSkills() {
            const input = document.getElementById('skill-input');
            const text = input.value.trim();
            if (!text) return;
            
            const skills = text.split(',').map(s => s.trim()).filter(s => s && !currentSkills.includes(s));
            if (skills.length) {
                currentSkills.push(...skills);
                renderSkills();
                input.value = '';
                input.focus();
            }
        }

        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            renderSkills();
        }

        function renderSkills() {
            document.getElementById('skills-container').innerHTML = currentSkills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <button type="button" onclick="removeSkill('${skill}')">Ã—</button>
                </div>
            `).join('');
        }

        function copyToClipboard() {
            const proposalEl = document.getElementById('proposal-text');
            const text = proposalEl.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied');
            });
        }

        function formatLink(url) {
            try { return new URL(url).hostname.replace('www.', ''); } 
            catch { return url; }
        }

        // Save proposal and track outcome
        async function saveAndSend() {
            if (!lastGeneratedResult || !lastRequestData) {
                showToast('Generate a proposal first');
                return;
            }
            
            if (proposalSaved) {
                showToast('Already saved! Check History â†’');
                return;
            }
            
            const btn = document.getElementById('save-send-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Saving...';
            
            try {
                // Get current proposal text (might be edited)
                const proposalText = document.getElementById('proposal-text').innerText;
                const wordCount = proposalText.trim().split(/\s+/).filter(w => w.length > 0).length;
                
                const saveData = {
                    job_title: lastRequestData.job_title,
                    company_name: lastRequestData.company_name,
                    job_description: lastRequestData.job_description,
                    proposal_text: proposalText,
                    skills_required: lastRequestData.skills_required,
                    industry: lastRequestData.industry || 'general',
                    task_type: lastRequestData.task_type || 'other',
                    word_count: wordCount,
                    similar_projects_used: (lastGeneratedResult.similar_projects || []).map(p => p.contract_id).filter(Boolean),
                    portfolio_links_used: lastGeneratedResult.portfolio_links_used || [],
                    confidence_score: lastGeneratedResult.confidence_score || 0,
                    temporary_link: document.getElementById('temporary-link-input').value.trim() || null
                };
                
                const res = await axios.post(`${API_BASE}/save`, saveData);
                
                proposalSaved = true;
                btn.innerHTML = 'âœ“ Saved';
                btn.classList.remove('action-btn-primary');
                btn.style.background = '#059669';  // Green
                
                showToast(`Saved! Track outcome in History`);
                
                // Show link to history
                setTimeout(() => {
                    btn.innerHTML = '<a href="history.html" style="color:white">View History â†’</a>';
                }, 1500);
                
            } catch (err) {
                showToast('Error: ' + (err.response?.data?.detail || err.message));
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function resetForm() {
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            isEditMode = false;
            originalProposalText = '';
            proposalSaved = false;
            lastGeneratedResult = null;
            
            // Clear temporary link input
            const tempLinkInput = document.getElementById('temporary-link-input');
            if (tempLinkInput) tempLinkInput.value = '';
            
            // Reset save button
            const saveBtn = document.getElementById('save-send-btn');
            if (saveBtn) {
                saveBtn.innerHTML = 'ðŸ“¤ Save & Send';
                saveBtn.disabled = false;
                saveBtn.style.background = '';
                saveBtn.classList.add('action-btn-primary');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Edit functionality
        function toggleEditMode() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            if (!isEditMode) {
                // Enter edit mode
                isEditMode = true;
                originalProposalText = proposalEl.innerText;
                proposalEl.setAttribute('contenteditable', 'true');
                proposalEl.classList.remove('proposal-body');
                proposalEl.classList.add('proposal-body-editable');
                proposalEl.focus();
                editBtnText.textContent = 'Editing...';
                editBtn.classList.add('action-btn-primary');
                editBanner.classList.remove('hidden');
            } else {
                // Exit edit mode (save)
                saveEdit();
            }
        }

        function saveEdit() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            isEditMode = false;
            proposalEl.setAttribute('contenteditable', 'false');
            proposalEl.classList.remove('proposal-body-editable');
            proposalEl.classList.add('proposal-body');
            editBtnText.textContent = 'Edit';
            editBtn.classList.remove('action-btn-primary');
            editBanner.classList.add('hidden');
            
            // Update word count
            updateWordCount();
            showToast('Saved');
        }

        function cancelEdit() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            isEditMode = false;
            proposalEl.innerText = originalProposalText;
            proposalEl.setAttribute('contenteditable', 'false');
            proposalEl.classList.remove('proposal-body-editable');
            proposalEl.classList.add('proposal-body');
            editBtnText.textContent = 'Edit';
            editBtn.classList.remove('action-btn-primary');
            editBanner.classList.add('hidden');
        }

        function updateWordCount() {
            const text = document.getElementById('proposal-text').innerText;
            const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').textContent = wordCount;
        }

        // Quick tweaks
        async function quickTweak(tweakType) {
            if (!lastRequestData) {
                showToast('Generate a proposal first');
                return;
            }

            const tweakData = { ...lastRequestData };
            
            switch(tweakType) {
                case 'shorter':
                    tweakData.max_word_count = Math.max(100, (tweakData.max_word_count || 150) - 50);
                    break;
                case 'friendlier':
                    tweakData.tone = 'friendly';
                    tweakData.proposal_style = 'casual';
                    break;
                case 'technical':
                    tweakData.proposal_style = 'technical';
                    tweakData.tone = 'analytical';
                    break;
                case 'confident':
                    tweakData.tone = 'confident';
                    break;
            }

            // Show loading
            showToast('Adjusting...');

            try {
                const res = await axios.post(`${API_BASE}/generate`, tweakData);
                const result = res.data;

                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                showToast('Done');
            } catch (err) {
                showToast('Something went wrong');
            }
        }

        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentSkills.length) {
                alert('Please add at least one skill');
                return;
            }

            const jobDesc = document.getElementById('job_description').value;
            const companyMatch = jobDesc.match(/(?:company|client|organization)[\s:]+([^\n]+)/i);
            const company = companyMatch ? companyMatch[1].trim().substring(0, 50) : 'Client';
            
            const titleMatch = jobDesc.match(/^(.+?)(?:\s*[-â€“]\s*|$)/);
            const title = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Project';

            const data = {
                company_name: company,
                job_title: title,
                job_description: jobDesc,
                skills_required: currentSkills,
                industry: 'general',
                task_type: document.getElementById('task_type').value || 'other',
                proposal_style: 'professional',
                tone: 'confident',
                max_word_count: 150,
                similar_projects_count: 3,
                include_portfolio: true,
                include_feedback: true,
                include_previous_proposals: true,
                include_timeline: includeTimeline,
                timeline_duration: document.getElementById('timeline_duration').value.trim() || null
            };

            // Store for rephrase functionality
            lastRequestData = data;

            // UI: Loading
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const res = await axios.post(`${API_BASE}/generate`, data);
                const result = res.data;

                // Store full result for saving
                lastGeneratedResult = result;
                proposalSaved = false;
                
                // Reset save button
                const saveBtn = document.getElementById('save-send-btn');
                saveBtn.innerHTML = 'ðŸ“¤ Save & Send';
                saveBtn.disabled = false;
                saveBtn.style.background = '';
                saveBtn.classList.add('action-btn-primary');

                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                // Similar projects
                const projects = result.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length
                    ? projects.map(p => `
                        <div class="project-item">
                            <p class="font-medium text-neutral-800 text-sm">${p.company}</p>
                            <p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' Â· ')}</p>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-neutral-500">None found</p>';

                // Portfolio
                const links = result.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = links.length
                    ? links.map(url => `<a href="${url}" target="_blank" class="link-item">${formatLink(url)}</a>`).join('')
                    : '<p class="text-sm text-neutral-500">None included</p>';

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');

            } catch (err) {
                alert('Error: ' + (err.response?.data?.detail || err.message));
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Proposal';
            }
        });

        document.getElementById('skill-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkills();
            }
        });
    </script>
</body>
</html>
