<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Disable caching for development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Proposal Generator | AI-Powered Upwork Proposals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        
        body { 
            background: #fafafa;
            min-height: 100vh;
        }

        /* Input styling */
        .input-field {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 14px;
            transition: border-color 0.15s, box-shadow 0.15s;
            width: 100%;
        }
        
        .input-field:hover {
            border-color: #d4d4d4;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #171717;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
        }

        .input-field::placeholder {
            color: #a3a3a3;
        }

        /* Select */
        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Skill tags */
        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #171717;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .skill-tag button {
            background: none;
            border: none;
            cursor: pointer;
            color: #a3a3a3;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            margin-left: 2px;
        }

        .skill-tag button:hover {
            color: #fff;
        }

        /* Primary button */
        .btn-primary {
            background: #171717;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
        }

        .btn-primary:hover {
            background: #262626;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #a3a3a3;
            cursor: not-allowed;
        }

        /* Secondary button */
        .btn-secondary {
            background: #fff;
            color: #171717;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #d4d4d4;
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .toggle-container:hover {
            border-color: #d4d4d4;
        }

        .toggle-switch {
            width: 40px;
            height: 22px;
            background: #e5e5e5;
            border-radius: 11px;
            position: relative;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: #171717;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toggle-switch.active::after {
            transform: translateX(18px);
        }

        /* Loading */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e5e5;
            border-top-color: #171717;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Proposal card */
        .proposal-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
        }

        .proposal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .proposal-body {
            padding: 24px;
            font-size: 15px;
            line-height: 1.75;
            color: #404040;
            white-space: pre-wrap;
        }

        /* Stats */
        .stat-item {
            text-align: center;
            padding: 0 16px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #171717;
        }

        .stat-label {
            font-size: 12px;
            color: #737373;
            margin-top: 2px;
        }

        /* Copy feedback */
        .copy-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #171717;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        /* Info section */
        .info-section {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 20px;
        }

        .info-title {
            font-size: 13px;
            font-weight: 600;
            color: #525252;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Project card */
        .project-item {
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .project-item:last-child {
            margin-bottom: 0;
        }

        /* Link item */
        .link-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #fafafa;
            border-radius: 6px;
            font-size: 13px;
            color: #525252;
            text-decoration: none;
            transition: background 0.15s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .link-item:hover {
            background: #f0f0f0;
            color: #171717;
        }

        /* Action buttons group */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: transparent;
            color: #737373;
            border: none;
            padding: 6px 10px;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.15s;
        }

        .action-btn:hover {
            color: #171717;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-btn svg {
            width: 15px;
            height: 15px;
        }

        .action-btn.action-btn-primary {
            background: #171717;
            color: #fff;
            border-radius: 6px;
            padding: 6px 12px;
        }

        .action-btn.action-btn-primary:hover {
            background: #262626;
        }

        /* Editable proposal */
        .proposal-body-editable {
            padding: 24px;
            font-size: 15px;
            line-height: 1.75;
            color: #171717;
            white-space: pre-wrap;
            min-height: 200px;
            border-left: 2px solid #171717;
            margin: 0;
            background: #fafafa;
            outline: none;
        }

        .proposal-body-editable:focus {
            background: #fff;
        }

        /* Edit mode indicator */
        .edit-mode-banner {
            background: #fafafa;
            border-bottom: 1px solid #e5e5e5;
            padding: 8px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .edit-mode-banner p {
            font-size: 12px;
            color: #737373;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #171717;
            color: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #171717;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #737373;
            padding: 4px;
        }

        .modal-close:hover {
            color: #171717;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .selection-section {
            margin-bottom: 24px;
        }

        .selection-section:last-child {
            margin-bottom: 0;
        }

        .selection-title {
            font-size: 14px;
            font-weight: 600;
            color: #171717;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selection-count {
            background: #171717;
            color: #fff;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .selection-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .selection-item:hover {
            border-color: #d4d4d4;
            background: #fafafa;
        }

        .selection-item.selected {
            border-color: #171717;
            background: #f5f5f5;
        }

        .selection-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d4d4d4;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .selection-item.selected .selection-checkbox {
            background: #171717;
            border-color: #171717;
        }

        .selection-checkbox svg {
            width: 12px;
            height: 12px;
            stroke: #fff;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .selection-item.selected .selection-checkbox svg {
            opacity: 1;
        }

        .selection-details {
            flex: 1;
            min-width: 0;
        }

        .selection-url {
            font-size: 13px;
            color: #525252;
            word-break: break-all;
            margin-bottom: 4px;
        }

        .selection-meta {
            font-size: 12px;
            color: #737373;
        }

        .selection-preview {
            font-size: 12px;
            color: #525252;
            font-style: italic;
            margin-top: 6px;
            padding: 8px;
            background: #fafafa;
            border-radius: 4px;
            line-height: 1.5;
        }

        .selection-rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #737373;
            margin-left: 8px;
        }

        .selection-rating svg {
            width: 12px;
            height: 12px;
            fill: #fbbf24;
        }

        .empty-selection {
            text-align: center;
            padding: 32px;
            color: #737373;
            font-size: 14px;
        }

        .modal-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .selection-summary {
            font-size: 13px;
            color: #525252;
        }

        .selection-summary strong {
            color: #171717;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-neutral-900">Proposal Generator</h1>
                <p class="text-xs text-neutral-500">AI-powered winning proposals</p>
            </div>
            <a href="training.html" class="btn-secondary inline-flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                Training Platform
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid lg:grid-cols-5 gap-8">
            
            <!-- Left: Form (narrower) -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-neutral-200 rounded-xl p-6">
                    <h2 class="text-base font-semibold text-neutral-900 mb-6">Job Details</h2>
                    
                    <form id="proposal-form" class="space-y-5">
                        <!-- Task Type (Optional - system auto-detects if not selected) -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">
                                Task Type 
                                <span class="text-neutral-400 font-normal">(optional)</span>
                            </label>
                            <select id="task_type" class="input-field">
                                <option value="">Auto-detect from description</option>
                                <option value="complete website">Complete Website / New Build</option>
                                <option value="enhance functionality">Enhance Functionality / Add Features</option>
                                <option value="redesign website">Redesign / Restyle Website</option>
                                <option value="bug fixes">Bug Fixes / Troubleshooting</option>
                                <option value="speed optimization">Speed Optimization / Performance</option>
                                <option value="migration">Content Migration / Platform Switch</option>
                                <option value="layout fixing">Layout Fixing / CSS Issues</option>
                                <option value="seo">SEO Optimization</option>
                                <option value="membership_setup">Membership / Subscription Setup</option>
                                <option value="consultation">Consultation / Strategy</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Skills -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Skills</label>
                            <div class="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    id="skill-input"
                                    placeholder="Add skills (comma separated)"
                                    class="input-field flex-1"
                                />
                                <button type="button" onclick="addSkills()" class="btn-secondary">Add</button>
                            </div>
                            <div id="skills-container" class="flex flex-wrap gap-2"></div>
                        </div>

                        <!-- Job Description -->
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Job Description</label>
                            <textarea 
                                id="job_description"
                                placeholder="Paste the job description..."
                                rows="8"
                                class="input-field resize-none"
                                required
                            ></textarea>
                        </div>

                        <!-- Timeline Toggle -->
                        <div>
                            <div class="toggle-container" onclick="toggleTimeline()">
                                <div>
                                    <p class="text-sm font-medium text-neutral-700">Include Timeline</p>
                                    <p class="text-xs text-neutral-500 mt-0.5">Add delivery duration to proposal</p>
                                </div>
                                <div id="timeline-toggle" class="toggle-switch"></div>
                            </div>
                            <div id="timeline-input" class="hidden mt-3">
                                <input 
                                    type="text" 
                                    id="timeline_duration"
                                    placeholder="e.g., 2-3 weeks"
                                    class="input-field"
                                />
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="space-y-3">
                            <button type="button" id="analyze-btn" onclick="analyzeJob()" class="btn-primary w-full">
                                <span class="flex items-center justify-center gap-2">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    Analyze & Select References
                                </span>
                            </button>
                            <button type="submit" id="generate-btn" class="btn-secondary w-full">
                                Quick Generate (Auto-select)
                            </button>
                            <p class="text-xs text-neutral-400 text-center">
                                Use "Analyze" to choose which portfolio items and feedback to include
                            </p>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right: Output (wider) -->
            <div class="lg:col-span-3">
                <!-- Empty State -->
                <div id="empty-state" class="bg-white border border-neutral-200 rounded-xl p-12 text-center">
                    <p class="text-neutral-400 text-sm">Fill in the job details to generate a proposal</p>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="hidden bg-white border border-neutral-200 rounded-xl p-12">
                    <div class="flex flex-col items-center">
                        <div class="loader mb-4"></div>
                        <p class="text-sm text-neutral-600">Generating proposal...</p>
                    </div>
                </div>

                <!-- Result State -->
                <div id="result-state" class="hidden space-y-6">
                    <!-- Proposal -->
                    <div class="proposal-card">
                        <div class="proposal-header">
                            <div class="flex items-center gap-6">
                                <div class="stat-item border-r border-neutral-200">
                                    <div class="stat-value" id="word-count">0</div>
                                    <div class="stat-label">words</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="quality-score">0%</div>
                                    <div class="stat-label">quality</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="toggleEditMode()" id="edit-btn" class="action-btn" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zM16.862 4.487L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                    </svg>
                                    <span id="edit-btn-text">Edit</span>
                                </button>
                                <span class="text-neutral-300">|</span>
                                <button onclick="copyToClipboard()" class="action-btn action-btn-primary" title="Copy">
                                    Copy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Edit mode banner (hidden by default) -->
                        <div id="edit-mode-banner" class="edit-mode-banner hidden">
                            <p>Editing mode ‚Äî click outside or press Escape to finish</p>
                            <div class="flex gap-2">
                                <button onclick="cancelEdit()" class="action-btn text-xs">Discard</button>
                                <button onclick="saveEdit()" class="action-btn action-btn-primary text-xs">Done</button>
                            </div>
                        </div>
                        
                        <div id="proposal-text" class="proposal-body"></div>
                    </div>

                    <!-- Quick Adjustments -->
                    <div class="flex flex-wrap items-center gap-2 px-1">
                        <span class="text-xs text-neutral-400">Adjust:</span>
                        <button onclick="quickTweak('shorter')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Shorter</button>
                        <span class="text-neutral-300">¬∑</span>
                        <button onclick="quickTweak('friendlier')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Friendlier</button>
                        <span class="text-neutral-300">¬∑</span>
                        <button onclick="quickTweak('technical')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Technical</button>
                        <span class="text-neutral-300">¬∑</span>
                        <button onclick="quickTweak('confident')" class="text-xs text-neutral-500 hover:text-neutral-900 transition-colors">Confident</button>
                    </div>

                    <!-- Similar Projects -->
                    <div class="info-section">
                        <div class="info-title">Similar Projects</div>
                        <div id="similar-projects">
                            <p class="text-sm text-neutral-500">None found</p>
                        </div>
                    </div>

                    <!-- Portfolio Links -->
                    <div class="info-section">
                        <div class="info-title">Portfolio References</div>
                        <div id="portfolio-links">
                            <p class="text-sm text-neutral-500">None included</p>
                        </div>
                    </div>

                    <!-- Start Fresh -->
                    <button onclick="resetForm()" class="w-full py-2 text-xs text-neutral-400 hover:text-neutral-600 transition-colors">
                        Start over
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <!-- Selection Modal -->
    <div id="selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Portfolio & Feedback</h3>
                <button class="modal-close" onclick="closeModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" id="modal-body">
                <!-- Loading state -->
                <div id="modal-loading" class="modal-loader">
                    <div class="loader mb-4"></div>
                    <p class="text-sm text-neutral-600">Analyzing similar projects...</p>
                </div>
                
                <!-- Content state -->
                <div id="modal-content-inner" class="hidden">
                    <!-- Winning Proposals Selection (NEW - Most Important) -->
                    <div class="selection-section">
                        <div class="selection-title">
                            <span>üèÜ Winning Proposals</span>
                            <span id="proposal-count" class="selection-count">0</span>
                        </div>
                        <p class="text-xs text-neutral-500 mb-3">Select a winning proposal to use as base (will be used EXACTLY as-is)</p>
                        <div id="proposal-selection-list"></div>
                    </div>
                    
                    <!-- Similar Projects Info -->
                    <div id="similar-projects-info" class="selection-section">
                        <div class="selection-title">
                            <span>Similar Projects Found</span>
                            <span id="projects-count" class="selection-count">0</span>
                        </div>
                        <div id="similar-projects-list"></div>
                    </div>
                    
                    <!-- Portfolio Selection -->
                    <div class="selection-section">
                        <div class="selection-title">
                            <span>Portfolio URLs</span>
                            <span id="portfolio-count" class="selection-count">0</span>
                        </div>
                        <p class="text-xs text-neutral-500 mb-3">Select which portfolio links to include in your proposal</p>
                        <div id="portfolio-selection-list"></div>
                    </div>
                    
                    <!-- Feedback Selection -->
                    <div class="selection-section">
                        <div class="selection-title">
                            <span>Client Feedback</span>
                            <span id="feedback-count" class="selection-count">0</span>
                        </div>
                        <p class="text-xs text-neutral-500 mb-3">Select which client feedback to reference in your proposal</p>
                        <div id="feedback-selection-list"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="selection-summary">
                    <span id="selection-summary-text">No items selected</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="btn-secondary">Cancel</button>
                    <button id="generate-with-selections-btn" onclick="generateWithSelections()" class="btn-primary">
                        Compile Proposal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CHANGE THIS TO TEST LOCALLY vs PRODUCTION
        // Local: 'http://127.0.0.1:8000/api/proposals'
        // Production: 'https://ml.genproposals.com/api/proposals'
        const API_BASE = 'https://ml.genproposals.com/api/proposals';
        
        let currentSkills = [];
        let includeTimeline = false;
        let isEditMode = false;
        let originalProposalText = '';
        let lastRequestData = null;
        
        // Selection modal state
        let analysisResult = null;
        let selectedPortfolioUrls = [];
        let selectedFeedbackItems = [];
        let selectedProposalText = null;

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Modal functions
        function openModal() {
            document.getElementById('selection-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('selection-modal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function togglePortfolioSelection(index) {
            const item = analysisResult.available_portfolio_items[index];
            const itemEl = document.getElementById(`portfolio-item-${index}`);
            
            const urlIndex = selectedPortfolioUrls.indexOf(item.url);
            if (urlIndex > -1) {
                selectedPortfolioUrls.splice(urlIndex, 1);
                itemEl.classList.remove('selected');
            } else {
                selectedPortfolioUrls.push(item.url);
                itemEl.classList.add('selected');
            }
            updateSelectionSummary();
        }

        function toggleFeedbackSelection(index) {
            const item = analysisResult.available_feedback_items[index];
            const itemEl = document.getElementById(`feedback-item-${index}`);
            
            const existingIndex = selectedFeedbackItems.findIndex(f => f.url === item.url);
            if (existingIndex > -1) {
                selectedFeedbackItems.splice(existingIndex, 1);
                itemEl.classList.remove('selected');
            } else {
                selectedFeedbackItems.push({
                    url: item.url,
                    text: item.text,
                    project_company: item.project_company
                });
                itemEl.classList.add('selected');
            }
            updateSelectionSummary();
        }

        function selectProposalText(index) {
            const item = analysisResult.available_proposal_texts[index];
            
            // Deselect all proposal items first (only one can be selected)
            document.querySelectorAll('[id^="proposal-item-"]').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Toggle selection
            if (selectedProposalText === item.proposal_text) {
                selectedProposalText = null;
            } else {
                selectedProposalText = item.proposal_text;
                document.getElementById(`proposal-item-${index}`).classList.add('selected');
            }
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const portfolioCount = selectedPortfolioUrls.length;
            const feedbackCount = selectedFeedbackItems.length;
            const hasProposal = selectedProposalText ? 1 : 0;
            const total = portfolioCount + feedbackCount + hasProposal;
            
            let text = 'No items selected';
            if (total > 0) {
                const parts = [];
                if (hasProposal) parts.push('1 proposal');
                if (portfolioCount > 0) parts.push(`${portfolioCount} portfolio`);
                if (feedbackCount > 0) parts.push(`${feedbackCount} feedback`);
                text = `<strong>${total}</strong> items selected (${parts.join(', ')})`;
            }
            document.getElementById('selection-summary-text').innerHTML = text;
            
            // Update generate button state - allow if proposal or any other item selected
            document.getElementById('generate-with-selections-btn').disabled = total === 0;
            
            // Update button text based on selection
            const btnText = hasProposal ? 'Use Selected Proposal' : 'Generate New Proposal';
            document.getElementById('generate-with-selections-btn').textContent = btnText;
        }

        function renderSelectionModal() {
            const proposalList = document.getElementById('proposal-selection-list');
            const portfolioList = document.getElementById('portfolio-selection-list');
            const feedbackList = document.getElementById('feedback-selection-list');
            const similarProjectsList = document.getElementById('similar-projects-list');
            
            // Render winning proposals (NEW)
            const proposalTexts = analysisResult.available_proposal_texts || [];
            document.getElementById('proposal-count').textContent = proposalTexts.length;
            
            if (proposalTexts.length > 0) {
                proposalList.innerHTML = proposalTexts.map((item, i) => `
                    <div id="proposal-item-${i}" class="selection-item" onclick="selectProposalText(${i})">
                        <div class="selection-checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="selection-details">
                            <div class="selection-meta" style="font-weight: 600; color: #171717; margin-bottom: 6px;">
                                ${item.project_company} - ${item.project_title}
                            </div>
                            <div class="selection-meta">Skills: ${(item.skills || []).slice(0, 5).join(', ') || 'N/A'}</div>
                            <div class="selection-preview" style="max-height: 120px; overflow-y: auto;">
                                ${item.proposal_text.substring(0, 400)}${item.proposal_text.length > 400 ? '...' : ''}
                            </div>
                            <div class="text-xs text-neutral-400 mt-2">${item.proposal_text.split(/\s+/).length} words</div>
                        </div>
                    </div>
                `).join('');
            } else {
                proposalList.innerHTML = '<div class="empty-selection">No winning proposals available from similar projects</div>';
            }
            
            // Render similar projects info
            const projects = analysisResult.similar_projects || [];
            document.getElementById('projects-count').textContent = projects.length;
            
            if (projects.length > 0) {
                similarProjectsList.innerHTML = projects.map((p, i) => `
                    <div class="project-item">
                        <p class="font-medium text-neutral-800 text-sm">${p.company || 'Unknown Company'}</p>
                        <p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' ¬∑ ') || 'No skills listed'}</p>
                        ${p.similarity_score ? `<p class="text-xs text-neutral-400 mt-1">Match: ${Math.round(p.similarity_score * 100)}%</p>` : ''}
                    </div>
                `).join('');
            } else {
                similarProjectsList.innerHTML = '<p class="text-sm text-neutral-500">No similar projects found</p>';
            }
            
            // Render portfolio items
            const portfolioItems = analysisResult.available_portfolio_items || [];
            document.getElementById('portfolio-count').textContent = portfolioItems.length;
            
            if (portfolioItems.length > 0) {
                portfolioList.innerHTML = portfolioItems.map((item, i) => `
                    <div id="portfolio-item-${i}" class="selection-item" onclick="togglePortfolioSelection(${i})">
                        <div class="selection-checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="selection-details">
                            <div class="selection-url">${item.url}</div>
                            <div class="selection-meta">From: ${item.project_company} - ${item.project_title}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                portfolioList.innerHTML = '<div class="empty-selection">No portfolio URLs available from similar projects</div>';
            }
            
            // Render feedback items
            const feedbackItems = analysisResult.available_feedback_items || [];
            document.getElementById('feedback-count').textContent = feedbackItems.length;
            
            if (feedbackItems.length > 0) {
                feedbackList.innerHTML = feedbackItems.map((item, i) => `
                    <div id="feedback-item-${i}" class="selection-item" onclick="toggleFeedbackSelection(${i})">
                        <div class="selection-checkbox">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="selection-details">
                            <div class="selection-url">${item.url}</div>
                            <div class="selection-meta">
                                From: ${item.project_company}
                                ${item.satisfaction_score ? `<span class="selection-rating"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>${item.satisfaction_score}/5</span>` : ''}
                            </div>
                            ${item.text ? `<div class="selection-preview">"${item.text}"</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                feedbackList.innerHTML = '<div class="empty-selection">No client feedback available from similar projects</div>';
            }
            
            // Reset selections
            selectedPortfolioUrls = [];
            selectedFeedbackItems = [];
            selectedProposalText = null;
            updateSelectionSummary();
            
            // Show content, hide loading
            document.getElementById('modal-loading').classList.add('hidden');
            document.getElementById('modal-content-inner').classList.remove('hidden');
        }

        async function analyzeJob() {
            if (!currentSkills.length) {
                alert('Please add at least one skill');
                return;
            }

            const jobDesc = document.getElementById('job_description').value;
            if (!jobDesc.trim()) {
                alert('Please enter a job description');
                return;
            }

            const companyMatch = jobDesc.match(/(?:company|client|organization)[\s:]+([^\n]+)/i);
            const company = companyMatch ? companyMatch[1].trim().substring(0, 50) : 'Client';
            
            const titleMatch = jobDesc.match(/^(.+?)(?:\s*[-‚Äì]\s*|$)/);
            const title = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Project';

            const analyzeData = {
                company_name: company,
                job_title: title,
                job_description: jobDesc,
                skills_required: currentSkills,
                industry: 'general',
                task_type: document.getElementById('task_type').value || null,
                similar_projects_count: 5
            };

            // Store for later use
            lastRequestData = {
                ...analyzeData,
                proposal_style: 'professional',
                tone: 'confident',
                max_word_count: 150,
                include_timeline: includeTimeline,
                timeline_duration: document.getElementById('timeline_duration').value.trim() || null
            };

            // Open modal with loading state
            document.getElementById('modal-loading').classList.remove('hidden');
            document.getElementById('modal-content-inner').classList.add('hidden');
            openModal();

            try {
                const res = await axios.post(`${API_BASE}/analyze`, analyzeData);
                analysisResult = res.data;
                renderSelectionModal();
            } catch (err) {
                closeModal();
                alert('Error analyzing job: ' + (err.response?.data?.detail || err.message));
            }
        }

        async function generateWithSelections() {
            // Allow if proposal selected OR any portfolio/feedback selected
            if (!selectedProposalText && selectedPortfolioUrls.length === 0 && selectedFeedbackItems.length === 0) {
                alert('Please select a proposal, portfolio item, or feedback');
                return;
            }

            const btn = document.getElementById('generate-with-selections-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto" style="width:16px;height:16px;border-width:2px;"></div>';

            const generateData = {
                ...lastRequestData,
                selected_portfolio_urls: selectedPortfolioUrls,
                selected_feedback_items: selectedFeedbackItems,
                selected_proposal_text: selectedProposalText,  // Include selected proposal text
                similar_projects: analysisResult.similar_projects || []
            };

            try {
                const res = await axios.post(`${API_BASE}/generate-with-selections`, generateData);
                const result = res.data;

                // Close modal
                closeModal();

                // Show result
                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                // Similar projects
                const projects = result.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length
                    ? projects.map(p => `
                        <div class="project-item">
                            <p class="font-medium text-neutral-800 text-sm">${p.company}</p>
                            <p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' ¬∑ ')}</p>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-neutral-500">None found</p>';

                // Portfolio
                const links = result.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = links.length
                    ? links.map(url => `<a href="${url}" target="_blank" class="link-item">${formatLink(url)}</a>`).join('')
                    : '<p class="text-sm text-neutral-500">None included</p>';

                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');

                const toastMsg = selectedProposalText ? 'Proposal compiled with your selections' : 'Proposal generated with your selections';
                showToast(toastMsg);

            } catch (err) {
                alert('Error generating proposal: ' + (err.response?.data?.detail || err.message));
            } finally {
                btn.disabled = false;
                btn.innerHTML = selectedProposalText ? 'Use Selected Proposal' : 'Generate New Proposal';
            }
        }

        function toggleTimeline() {
            includeTimeline = !includeTimeline;
            document.getElementById('timeline-toggle').classList.toggle('active', includeTimeline);
            document.getElementById('timeline-input').classList.toggle('hidden', !includeTimeline);
            if (!includeTimeline) {
                document.getElementById('timeline_duration').value = '';
            }
        }

        function addSkills() {
            const input = document.getElementById('skill-input');
            const text = input.value.trim();
            if (!text) return;
            
            const skills = text.split(',').map(s => s.trim()).filter(s => s && !currentSkills.includes(s));
            if (skills.length) {
                currentSkills.push(...skills);
                renderSkills();
                input.value = '';
                input.focus();
            }
        }

        function removeSkill(skill) {
            currentSkills = currentSkills.filter(s => s !== skill);
            renderSkills();
        }

        function renderSkills() {
            document.getElementById('skills-container').innerHTML = currentSkills.map(skill => `
                <div class="skill-tag">
                    ${skill}
                    <button type="button" onclick="removeSkill('${skill}')">√ó</button>
                </div>
            `).join('');
        }

        function copyToClipboard() {
            const proposalEl = document.getElementById('proposal-text');
            const text = proposalEl.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied');
            });
        }

        function formatLink(url) {
            try { return new URL(url).hostname.replace('www.', ''); } 
            catch { return url; }
        }

        function resetForm() {
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            isEditMode = false;
            originalProposalText = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Edit functionality
        function toggleEditMode() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            if (!isEditMode) {
                // Enter edit mode
                isEditMode = true;
                originalProposalText = proposalEl.innerText;
                proposalEl.setAttribute('contenteditable', 'true');
                proposalEl.classList.remove('proposal-body');
                proposalEl.classList.add('proposal-body-editable');
                proposalEl.focus();
                editBtnText.textContent = 'Editing...';
                editBtn.classList.add('action-btn-primary');
                editBanner.classList.remove('hidden');
            } else {
                // Exit edit mode (save)
                saveEdit();
            }
        }

        function saveEdit() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            isEditMode = false;
            proposalEl.setAttribute('contenteditable', 'false');
            proposalEl.classList.remove('proposal-body-editable');
            proposalEl.classList.add('proposal-body');
            editBtnText.textContent = 'Edit';
            editBtn.classList.remove('action-btn-primary');
            editBanner.classList.add('hidden');
            
            // Update word count
            updateWordCount();
            showToast('Saved');
        }

        function cancelEdit() {
            const proposalEl = document.getElementById('proposal-text');
            const editBtn = document.getElementById('edit-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            const editBanner = document.getElementById('edit-mode-banner');
            
            isEditMode = false;
            proposalEl.innerText = originalProposalText;
            proposalEl.setAttribute('contenteditable', 'false');
            proposalEl.classList.remove('proposal-body-editable');
            proposalEl.classList.add('proposal-body');
            editBtnText.textContent = 'Edit';
            editBtn.classList.remove('action-btn-primary');
            editBanner.classList.add('hidden');
        }

        function updateWordCount() {
            const text = document.getElementById('proposal-text').innerText;
            const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('word-count').textContent = wordCount;
        }

        // Quick tweaks
        async function quickTweak(tweakType) {
            if (!lastRequestData) {
                showToast('Generate a proposal first');
                return;
            }

            const tweakData = { ...lastRequestData };
            
            switch(tweakType) {
                case 'shorter':
                    tweakData.max_word_count = Math.max(100, (tweakData.max_word_count || 150) - 50);
                    break;
                case 'friendlier':
                    tweakData.tone = 'friendly';
                    tweakData.proposal_style = 'casual';
                    break;
                case 'technical':
                    tweakData.proposal_style = 'technical';
                    tweakData.tone = 'analytical';
                    break;
                case 'confident':
                    tweakData.tone = 'confident';
                    break;
            }

            // Show loading
            showToast('Adjusting...');

            try {
                const res = await axios.post(`${API_BASE}/generate`, tweakData);
                const result = res.data;

                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                showToast('Done');
            } catch (err) {
                showToast('Something went wrong');
            }
        }

        document.getElementById('proposal-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentSkills.length) {
                alert('Please add at least one skill');
                return;
            }

            const jobDesc = document.getElementById('job_description').value;
            const companyMatch = jobDesc.match(/(?:company|client|organization)[\s:]+([^\n]+)/i);
            const company = companyMatch ? companyMatch[1].trim().substring(0, 50) : 'Client';
            
            const titleMatch = jobDesc.match(/^(.+?)(?:\s*[-‚Äì]\s*|$)/);
            const title = titleMatch ? titleMatch[1].trim().substring(0, 50) : 'Project';

            const data = {
                company_name: company,
                job_title: title,
                job_description: jobDesc,
                skills_required: currentSkills,
                industry: 'general',
                // Send task_type only if user explicitly selected one (otherwise backend auto-detects)
                task_type: document.getElementById('task_type').value || null,
                proposal_style: 'professional',
                tone: 'confident',
                max_word_count: 150,
                similar_projects_count: 3,
                include_portfolio: true,
                include_feedback: true,
                include_previous_proposals: true,
                include_timeline: includeTimeline,
                timeline_duration: document.getElementById('timeline_duration').value.trim() || null
            };

            // Store for rephrase functionality
            lastRequestData = data;

            // UI: Loading
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-state').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const res = await axios.post(`${API_BASE}/generate`, data);
                const result = res.data;

                document.getElementById('proposal-text').innerText = result.generated_proposal;
                document.getElementById('word-count').innerText = result.word_count;
                document.getElementById('quality-score').innerText = Math.round((result.confidence_score || 0.85) * 100) + '%';

                // Similar projects
                const projects = result.similar_projects || [];
                document.getElementById('similar-projects').innerHTML = projects.length
                    ? projects.map(p => `
                        <div class="project-item">
                            <p class="font-medium text-neutral-800 text-sm">${p.company}</p>
                            <p class="text-xs text-neutral-500 mt-1">${(p.skills || []).slice(0, 4).join(' ¬∑ ')}</p>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-neutral-500">None found</p>';

                // Portfolio
                const links = result.portfolio_links_used || [];
                document.getElementById('portfolio-links').innerHTML = links.length
                    ? links.map(url => `<a href="${url}" target="_blank" class="link-item">${formatLink(url)}</a>`).join('')
                    : '<p class="text-sm text-neutral-500">None included</p>';

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('result-state').classList.remove('hidden');

            } catch (err) {
                alert('Error: ' + (err.response?.data?.detail || err.message));
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Generate Proposal';
            }
        });

        document.getElementById('skill-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkills();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Close modal when clicking overlay background
        document.getElementById('selection-modal').addEventListener('click', (e) => {
            if (e.target.id === 'selection-modal') {
                closeModal();
            }
        });
    </script>
</body>
</html>
