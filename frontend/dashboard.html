<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="image.png">
    <title>Analytics Dashboard | Proposal Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #fafafa; min-height: 100vh; }
        .input-field { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 14px; font-size: 14px; }
        .input-field:focus { outline: none; border-color: #171717; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .stat-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #171717; }
        .stat-label { font-size: 13px; color: #737373; margin-top: 4px; }
        .stat-change { font-size: 12px; font-weight: 500; }
        .btn-secondary { background: #fff; color: #171717; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-secondary:hover { background: #fafafa; border-color: #d4d4d4; }
        .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; }
        .funnel-bar { height: 36px; border-radius: 6px; transition: width 0.5s ease; }
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-overlay.hidden { display: none; }
        .auth-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 320px; width: 90%; }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #171717; color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 13px; opacity: 0; transform: translateY(8px); transition: all 0.2s; z-index: 200; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .nav-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #737373; transition: all 0.15s; cursor: pointer; text-decoration: none; position: relative; }
        .nav-icon:hover { background: #f5f5f5; color: #171717; }
        .nav-icon svg { width: 18px; height: 18px; }
        .nav-icon .tooltip { position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: #171717; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
        .nav-icon:hover .tooltip { opacity: 1; }
        .nav-icon.active { background: #171717; color: #fff; }
        .nav-icon.active:hover { background: #262626; }
        .nav-icon.active .tooltip { display: none; }
        .user-badge { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; color: #525252; }
        .user-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-overlay hidden" id="auth-overlay">
        <div class="auth-modal">
            <div class="flex items-center gap-3 mb-5">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#171717" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <h2 class="text-base font-semibold">Enter API Key</h2>
            </div>
            <form onsubmit="authenticate(event)">
                <input type="password" id="api-key-input" class="input-field w-full mb-3" placeholder="API key" required>
                <label class="flex items-center gap-2 mb-4 text-xs text-neutral-500"><input type="checkbox" id="remember-key" checked> Remember me</label>
                <button type="submit" class="w-full bg-neutral-900 text-white py-3 rounded-lg font-medium text-sm" id="auth-btn">Continue</button>
                <p class="text-xs text-red-500 text-center mt-3" id="auth-error"></p>
            </form>
        </div>
    </div>

    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-neutral-900 rounded-lg flex items-center justify-center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                </div>
                <span class="font-semibold text-neutral-900 text-sm">Analytics</span>
                <select id="date-range" class="input-field text-xs py-1.5 px-3 ml-4" onchange="loadAll()">
                    <option value="all">All Time</option>
                    <option value="7d">7 Days</option>
                    <option value="30d" selected>30 Days</option>
                    <option value="90d">90 Days</option>
                </select>
            </div>
            <div class="flex items-center gap-1" id="nav-links">
                <a href="index.html" class="nav-icon" title="Generate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                    <span class="tooltip">Generate</span>
                </a>
                <span class="nav-icon active" title="Analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                </span>
                <a href="history.html" class="nav-icon" title="History">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span class="tooltip">History</span>
                </a>
                <a href="training.html" class="nav-icon" title="Training">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                    <span class="tooltip">Training</span>
                </a>
                <a href="admin.html" class="nav-icon" id="nav-admin" title="Admin" style="display:none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    <span class="tooltip">Admin</span>
                </a>
                <div class="w-px h-6 bg-neutral-200 mx-2"></div>
                <div class="user-badge" id="user-badge"><span class="dot"></span><span id="user-role">Admin</span></div>
                <button onclick="logout()" class="nav-icon" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    <span class="tooltip">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card">
                <div class="stat-value" id="s-total">-</div>
                <div class="stat-label">Total Proposals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-blue-600" id="s-ai">-</div>
                <div class="stat-label">AI Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-amber-600" id="s-manual">-</div>
                <div class="stat-label">Manual</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-green-600" id="s-hired">-</div>
                <div class="stat-label">Hired <span class="text-neutral-400 text-sm" id="s-rate"></span></div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Conversion Funnel -->
            <div class="card p-6">
                <h2 class="font-semibold text-neutral-900 mb-4">Conversion Funnel</h2>
                <div class="space-y-3" id="funnel-container">
                    <div class="animate-pulse bg-neutral-100 h-10 rounded"></div>
                </div>
            </div>

            <!-- AI vs Manual Comparison -->
            <div class="card p-6">
                <h2 class="font-semibold text-neutral-900 mb-4">AI vs Manual Performance</h2>
                <div id="comparison-container">
                    <canvas id="comparison-chart" height="180"></canvas>
                </div>
                <div class="mt-4 p-3 bg-neutral-50 rounded-lg text-center" id="effectiveness-badge">
                    <span class="text-sm text-neutral-600">AI is </span>
                    <span class="font-bold text-lg text-green-600" id="effectiveness-value">-</span>
                    <span class="text-sm text-neutral-600"> more effective</span>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Trends Chart -->
            <div class="card p-6">
                <h2 class="font-semibold text-neutral-900 mb-4">Proposal Trends</h2>
                <canvas id="trends-chart" height="200"></canvas>
            </div>

            <!-- Top Skills -->
            <div class="card p-6">
                <h2 class="font-semibold text-neutral-900 mb-4">Top Performing Skills</h2>
                <div id="skills-container" class="space-y-2">
                    <div class="animate-pulse bg-neutral-100 h-8 rounded"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        const API = 'https://ml.genproposals.com/api';
        let apiKey = localStorage.getItem('app_api_key') || '';
        let userRole = null;
        let comparisonChart, trendsChart;

        axios.interceptors.request.use(c => { if (apiKey) c.headers['X-API-Key'] = apiKey; return c; });
        axios.interceptors.response.use(r => r, e => {
            if (e.response?.status === 401 || e.response?.status === 403) {
                apiKey = ''; localStorage.removeItem('app_api_key');
                document.getElementById('auth-overlay').classList.remove('hidden');
            }
            return Promise.reject(e);
        });

        document.addEventListener('DOMContentLoaded', () => apiKey ? verify() : showAuth());

        function showAuth() { document.getElementById('auth-overlay').classList.remove('hidden'); }
        function hideAuth() { document.getElementById('auth-overlay').classList.add('hidden'); }
        function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
        function logout() { apiKey = ''; userRole = null; localStorage.removeItem('app_api_key'); location.reload(); }

        function updateNav() {
            const isSuper = userRole === 'super_admin';
            document.getElementById('nav-admin').style.display = isSuper ? 'flex' : 'none';
            document.getElementById('user-role').textContent = isSuper ? 'Super Admin' : 'Admin';
        }

        async function verify() {
            try { 
                const { data } = await axios.get(`${API}/auth/verify`);
                userRole = data.role;
                hideAuth(); 
                updateNav();
                loadAll(); 
            }
            catch { showAuth(); }
        }

        async function authenticate(e) {
            e.preventDefault();
            const btn = document.getElementById('auth-btn'), err = document.getElementById('auth-error');
            apiKey = document.getElementById('api-key-input').value.trim();
            btn.disabled = true; btn.textContent = 'Verifying...'; err.textContent = '';
            try {
                const { data } = await axios.get(`${API}/auth/verify`);
                userRole = data.role;
                if (document.getElementById('remember-key').checked) localStorage.setItem('app_api_key', apiKey);
                hideAuth();
                updateNav();
                loadAll();
            } catch { err.textContent = 'Invalid key'; apiKey = ''; }
            finally { btn.disabled = false; btn.textContent = 'Continue'; }
        }

        function getRange() { return document.getElementById('date-range').value; }

        async function loadAll() {
            const range = getRange();
            await Promise.all([loadSummary(range), loadFunnel(range), loadComparison(range), loadTrends(range), loadSkills(range)]);
        }

        async function loadSummary(range) {
            try {
                const { data } = await axios.get(`${API}/analytics/summary?range=${range}`);
                document.getElementById('s-total').textContent = data.total_proposals ?? 0;
                document.getElementById('s-ai').textContent = data.ai_generated_count ?? 0;
                document.getElementById('s-manual').textContent = data.manual_count ?? 0;
                document.getElementById('s-hired').textContent = data.total_hired ?? 0;
                document.getElementById('s-rate').textContent = data.total_proposals ? `(${data.overall_hire_rate}%)` : '';
            } catch (e) { console.error('Summary error:', e); document.querySelectorAll('[id^="s-"]').forEach(el => el.textContent = '0'); }
        }

        async function loadFunnel(range) {
            try {
                const { data } = await axios.get(`${API}/analytics/funnel?range=${range}`);
                if (!data.funnel?.length) { document.getElementById('funnel-container').innerHTML = '<p class="text-neutral-400 text-sm">No proposals yet</p>'; return; }
                const colors = { Sent: '#e5e5e5', Viewed: '#dbeafe', Discussed: '#ede9fe', Hired: '#d1fae5' };
                const textColors = { Sent: '#525252', Viewed: '#1e40af', Discussed: '#6d28d9', Hired: '#065f46' };
                document.getElementById('funnel-container').innerHTML = data.funnel.map(s => `
                    <div class="flex items-center gap-3">
                        <div class="w-20 text-sm font-medium text-neutral-700">${s.stage}</div>
                        <div class="flex-1 bg-neutral-100 rounded-md overflow-hidden h-9">
                            <div class="funnel-bar flex items-center px-3" style="width:${s.percentage}%;background:${colors[s.stage]}">
                                <span class="text-sm font-semibold" style="color:${textColors[s.stage]}">${s.count}</span>
                            </div>
                        </div>
                        <div class="w-14 text-right text-sm text-neutral-500">${s.percentage}%</div>
                    </div>
                `).join('');
            } catch (e) { console.error('Funnel error:', e); document.getElementById('funnel-container').innerHTML = '<p class="text-neutral-400 text-sm">Error loading funnel</p>'; }
        }

        async function loadComparison(range) {
            try {
                const { data } = await axios.get(`${API}/analytics/comparison?range=${range}`);
                const ctx = document.getElementById('comparison-chart').getContext('2d');
                if (comparisonChart) comparisonChart.destroy();
                const noData = !data.ai_generated?.total && !data.manual?.total;
                if (noData) { document.getElementById('effectiveness-badge').innerHTML = '<span class="text-sm text-neutral-400">No comparison data yet</span>'; }
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['View Rate', 'Hire Rate'],
                        datasets: [
                            { label: 'AI Generated', data: [data.ai_generated?.view_rate ?? 0, data.ai_generated?.hire_rate ?? 0], backgroundColor: '#3b82f6' },
                            { label: 'Manual', data: [data.manual?.view_rate ?? 0, data.manual?.hire_rate ?? 0], backgroundColor: '#f59e0b' }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true, max: 100 } } }
                });
                if (!noData) {
                    const eff = data.ai_effectiveness ?? 1;
                    const effEl = document.getElementById('effectiveness-value');
                    effEl.textContent = eff === Infinity || eff > 100 ? 'âˆž' : eff >= 1 ? `${((eff - 1) * 100).toFixed(0)}%` : `${((1 - eff) * 100).toFixed(0)}% less`;
                    effEl.className = `font-bold text-lg ${eff >= 1 ? 'text-green-600' : 'text-red-500'}`;
                    document.getElementById('effectiveness-badge').innerHTML = `<span class="text-sm text-neutral-600">AI is </span><span class="font-bold text-lg ${eff >= 1 ? 'text-green-600' : 'text-red-500'}" id="effectiveness-value">${effEl.textContent}</span><span class="text-sm text-neutral-600"> ${eff >= 1 ? 'more effective' : ''}</span>`;
                }
            } catch (e) { console.error('Comparison error:', e); }
        }

        async function loadTrends(range) {
            try {
                const { data } = await axios.get(`${API}/analytics/trends?range=${range}`);
                const ctx = document.getElementById('trends-chart').getContext('2d');
                if (trendsChart) trendsChart.destroy();
                if (!data.data?.length) { ctx.font = '14px Inter'; ctx.fillStyle = '#a3a3a3'; ctx.textAlign = 'center'; ctx.fillText('No trend data yet', ctx.canvas.width / 2, ctx.canvas.height / 2); return; }
                trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => d.date?.slice(5) ?? ''),
                        datasets: [
                            { label: 'Sent', data: data.data.map(d => d.sent ?? 0), borderColor: '#6b7280', tension: 0.3, fill: false },
                            { label: 'Hired', data: data.data.map(d => d.hired ?? 0), borderColor: '#10b981', tension: 0.3, fill: false }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                });
            } catch (e) { console.error('Trends error:', e); }
        }

        async function loadSkills(range) {
            try {
                const { data } = await axios.get(`${API}/analytics/skills?range=${range}&limit=8`);
                if (!data.skills.length) {
                    document.getElementById('skills-container').innerHTML = '<p class="text-neutral-400 text-sm">No data yet</p>';
                    return;
                }
                const maxTotal = Math.max(...data.skills.map(s => s.total));
                document.getElementById('skills-container').innerHTML = data.skills.map(s => `
                    <div class="flex items-center gap-3">
                        <div class="w-24 text-sm font-medium text-neutral-700 truncate" title="${s.skill}">${s.skill}</div>
                        <div class="flex-1 bg-neutral-100 rounded h-6 overflow-hidden">
                            <div class="h-full bg-green-100 flex items-center px-2" style="width:${(s.total/maxTotal)*100}%">
                                <span class="text-xs font-medium text-green-700">${s.hired}/${s.total}</span>
                            </div>
                        </div>
                        <div class="w-12 text-right text-sm font-medium ${s.hire_rate >= 20 ? 'text-green-600' : 'text-neutral-500'}">${s.hire_rate}%</div>
                    </div>
                `).join('');
            } catch (e) { console.error('Skills error:', e); }
        }
    </script>
</body>
</html>
