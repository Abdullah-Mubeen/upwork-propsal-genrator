<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="image.png">
    <title>Admin Dashboard | Proposal Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #fafafa; min-height: 100vh; }
        .input-field { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 14px; font-size: 14px; transition: all 0.15s; }
        .input-field:focus { outline: none; border-color: #171717; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .stat-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #171717; }
        .stat-label { font-size: 13px; color: #737373; margin-top: 4px; }
        .btn-primary { background: #171717; color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-primary:hover { background: #262626; }
        .btn-primary:disabled { background: #a3a3a3; cursor: not-allowed; }
        .btn-secondary { background: #fff; color: #171717; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-secondary:hover { background: #fafafa; border-color: #d4d4d4; }
        .btn-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 8px; padding: 8px 12px; font-weight: 500; font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .btn-danger:hover { background: #fee2e2; }
        .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fef2f2; color: #dc2626; }
        .badge-yellow { background: #fef9c3; color: #a16207; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .perm-tag { display: inline-flex; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin: 2px; background: #f5f5f5; color: #525252; border: 1px solid #e5e5e5; }
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-overlay.hidden { display: none; }
        .auth-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background: #fff; border-radius: 12px; padding: 24px; max-width: 420px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #171717; color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 13px; opacity: 0; transform: translateY(8px); transition: all 0.2s; z-index: 200; }
        .toast.error { background: #dc2626; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .key-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 16px; transition: all 0.15s; }
        .key-card:hover { border-color: #d4d4d4; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .activity-item { padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .activity-item:last-child { border-bottom: none; }
        .checkbox-label { display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: all 0.15s; font-size: 13px; color: #525252; }
        .checkbox-label:hover { background: #f5f5f5; }
        .checkbox-label input { width: 16px; height: 16px; accent-color: #171717; }
        .skeleton { background: linear-gradient(90deg, #f5f5f5 25%, #e5e5e5 50%, #f5f5f5 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-modal">
            <div class="flex items-center gap-3 mb-5">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#171717" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <h2 class="text-base font-semibold text-neutral-900">Admin Access Required</h2>
            </div>
            <form onsubmit="authenticate(event)">
                <input type="password" id="api-key-input" class="input-field w-full mb-3" placeholder="Master Admin Key" required autocomplete="off">
                <label class="flex items-center gap-2 mb-4 text-xs text-neutral-500 cursor-pointer">
                    <input type="checkbox" id="remember-key" checked class="accent-neutral-900"> Remember me
                </label>
                <button type="submit" class="btn-primary w-full py-3" id="auth-btn">Continue</button>
                <p class="text-xs text-red-500 text-center mt-3 min-h-[16px]" id="auth-error"></p>
            </form>
        </div>
    </div>

    <!-- Create Key Modal -->
    <div class="modal-overlay hidden" id="create-modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-base font-semibold text-neutral-900">Create API Key</h2>
                <button onclick="closeCreateModal()" class="text-neutral-400 hover:text-neutral-600 transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <form onsubmit="createKey(event)" id="create-key-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">User's Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="key-name" class="input-field w-full" placeholder="e.g. John Doe" required maxlength="100">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">Email (Optional)</label>
                    <input type="email" id="key-email" class="input-field w-full" placeholder="e.g. john@example.com" maxlength="200">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Permissions</label>
                    <div class="grid grid-cols-2 gap-1 p-2 bg-neutral-50 rounded-lg border border-neutral-100">
                        <label class="checkbox-label"><input type="checkbox" value="read" checked class="perm-check"> Read</label>
                        <label class="checkbox-label"><input type="checkbox" value="generate" checked class="perm-check"> Generate</label>
                        <label class="checkbox-label"><input type="checkbox" value="write" class="perm-check"> Write</label>
                        <label class="checkbox-label"><input type="checkbox" value="training" class="perm-check"> Training</label>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-1">Expires In (days)</label>
                        <input type="number" id="key-expiry" class="input-field w-full" placeholder="Never" min="1" max="365">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-1">Usage Limit</label>
                        <input type="number" id="key-limit" class="input-field w-full" placeholder="Unlimited" min="1">
                    </div>
                </div>
                
                <div class="mb-5">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">Notes</label>
                    <input type="text" id="key-desc" class="input-field w-full" placeholder="Optional notes about this user" maxlength="500">
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeCreateModal()" class="btn-secondary flex-1">Cancel</button>
                    <button type="submit" class="btn-primary flex-1" id="create-btn">Create Access</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Created Success Modal -->
    <div class="modal-overlay hidden" id="key-created-modal">
        <div class="modal-content">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                </div>
                <h2 class="text-lg font-semibold text-neutral-900">API Key Created</h2>
                <p class="text-sm text-neutral-500 mt-1">Save this key now — it won't be shown again!</p>
            </div>
            <div class="bg-neutral-100 p-4 rounded-lg mb-4 break-all font-mono text-sm text-neutral-800 select-all border border-neutral-200" id="new-key-value"></div>
            <div class="flex gap-3">
                <button onclick="copyKey()" class="btn-secondary flex-1 flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy
                </button>
                <button onclick="closeKeyCreatedModal()" class="btn-primary flex-1">Done</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-lg font-semibold text-neutral-900">Admin Dashboard</h1>
                <p class="text-xs text-neutral-500">API Key Management & Activity Logs</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="dashboard.html" class="btn-secondary inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    Analytics
                </a>
                <a href="index.html" class="btn-secondary inline-flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    Generate
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card">
                <div class="stat-value" id="stat-keys">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-green-600" id="stat-active">-</div>
                <div class="stat-label">Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-blue-600" id="stat-today">-</div>
                <div class="stat-label">Today's Activity</div>
            </div>
            <div class="stat-card">
                <div class="stat-value text-amber-600" id="stat-week">-</div>
                <div class="stat-label">Week Activity</div>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Users with Access -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-neutral-900">Users with Access</h2>
                    <button onclick="openCreateModal()" class="btn-primary text-sm py-2 px-4 inline-flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Add User
                    </button>
                </div>
                <div class="space-y-3" id="keys-list">
                    <div class="space-y-3">
                        <div class="key-card"><div class="skeleton h-4 w-3/4 mb-2"></div><div class="skeleton h-3 w-1/2"></div></div>
                        <div class="key-card"><div class="skeleton h-4 w-3/4 mb-2"></div><div class="skeleton h-3 w-1/2"></div></div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-neutral-900">Activity</h2>
                    <select id="activity-filter" class="input-field text-sm py-2" onchange="loadActivity()">
                        <option value="">All</option>
                        <option value="create_user">Access Granted</option>
                        <option value="revoke_user">Access Revoked</option>
                        <option value="generate">Proposal Generated</option>
                    </select>
                </div>
                <div class="max-h-[400px] overflow-y-auto" id="activity-list">
                    <div class="space-y-3 py-4">
                        <div class="flex gap-3 items-center"><div class="skeleton h-8 w-16"></div><div class="skeleton h-4 flex-1"></div></div>
                        <div class="flex gap-3 items-center"><div class="skeleton h-8 w-16"></div><div class="skeleton h-4 flex-1"></div></div>
                        <div class="flex gap-3 items-center"><div class="skeleton h-8 w-16"></div><div class="skeleton h-4 flex-1"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8000/api' 
            : 'https://ml.genproposals.com/api';
        
        let apiKey = localStorage.getItem('admin_api_key') || '';
        let newKeyValue = '';

        // Axios interceptor for auth
        axios.interceptors.request.use(config => {
            if (apiKey) config.headers['X-API-Key'] = apiKey;
            return config;
        });

        axios.interceptors.response.use(
            response => response,
            error => {
                if (error.response?.status === 401 || error.response?.status === 403) {
                    if (error.response?.data?.detail?.includes('Admin') || 
                        error.response?.data?.detail?.includes('admin')) {
                        showAuth();
                    }
                }
                return Promise.reject(error);
            }
        );

        document.addEventListener('DOMContentLoaded', () => {
            if (apiKey) {
                verifyAndLoad();
            } else {
                showAuth();
            }
        });

        function showAuth() {
            document.getElementById('auth-overlay').classList.remove('hidden');
            document.getElementById('api-key-input').focus();
        }

        function hideAuth() {
            document.getElementById('auth-overlay').classList.add('hidden');
        }

        function toast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = isError ? 'toast error show' : 'toast show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function verifyAndLoad() {
            try {
                const { data } = await axios.get(`${API}/auth/verify`);
                if (!data.is_admin) {
                    throw new Error('Admin access required');
                }
                hideAuth();
                loadAll();
            } catch (err) {
                apiKey = '';
                localStorage.removeItem('admin_api_key');
                showAuth();
            }
        }

        async function authenticate(e) {
            e.preventDefault();
            const btn = document.getElementById('auth-btn');
            const errEl = document.getElementById('auth-error');
            
            apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) {
                errEl.textContent = 'Please enter an API key';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            errEl.textContent = '';
            
            try {
                const { data } = await axios.get(`${API}/auth/verify`);
                if (!data.is_admin) {
                    throw new Error('Admin access required');
                }
                if (document.getElementById('remember-key').checked) {
                    localStorage.setItem('admin_api_key', apiKey);
                }
                hideAuth();
                loadAll();
            } catch (err) {
                errEl.textContent = err.response?.data?.detail || 'Invalid key or insufficient permissions';
                apiKey = '';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Continue';
            }
        }

        async function loadAll() {
            await Promise.all([loadStats(), loadKeys(), loadActivity()]);
        }

        async function loadStats() {
            try {
                const { data } = await axios.get(`${API}/admin/stats`);
                document.getElementById('stat-keys').textContent = data.keys?.total ?? 0;
                document.getElementById('stat-active').textContent = data.keys?.active ?? 0;
                document.getElementById('stat-today').textContent = data.activity?.today ?? 0;
                document.getElementById('stat-week').textContent = data.activity?.week ?? 0;
            } catch (e) {
                console.error('Stats error:', e);
                document.getElementById('stat-keys').textContent = '–';
                document.getElementById('stat-active').textContent = '–';
                document.getElementById('stat-today').textContent = '–';
                document.getElementById('stat-week').textContent = '–';
            }
        }

        async function loadKeys() {
            const container = document.getElementById('keys-list');
            try {
                const { data } = await axios.get(`${API}/admin/keys`);
                
                if (!data.keys?.length) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-neutral-400 mb-2">No users yet</div>
                            <button onclick="openCreateModal()" class="text-blue-600 text-sm hover:underline">Add your first user</button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.keys.map(k => {
                    const statusBadge = k.status === 'active' 
                        ? '<span class="badge badge-green">Active</span>'
                        : k.status === 'expired'
                        ? '<span class="badge badge-yellow">Expired</span>'
                        : '<span class="badge badge-red">Revoked</span>';
                    
                    const expiryText = k.expires_at 
                        ? `Expires ${formatDate(k.expires_at)}`
                        : 'No expiry';
                    
                    const usageText = k.usage_limit 
                        ? `${k.used_count || 0}/${k.usage_limit} uses`
                        : `${k.used_count || 0} uses`;
                    
                    const emailDisplay = k.email ? `<div class="text-xs text-neutral-400 mt-0.5">${escapeHtml(k.email)}</div>` : '';
                    
                    return `
                        <div class="key-card">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <div class="font-medium text-neutral-900">${escapeHtml(k.name)}</div>
                                    ${emailDisplay}
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="flex flex-wrap gap-1 mb-3">
                                ${k.permissions.map(p => `<span class="perm-tag">${p}</span>`).join('')}
                            </div>
                            <div class="flex items-center justify-between text-xs text-neutral-500">
                                <span>${usageText} • ${expiryText}</span>
                                ${k.status === 'active' ? `
                                    <button onclick="revokeKey('${k.id}', '${escapeHtml(k.name).replace(/'/g, "\\'")}', this)" class="btn-danger">Revoke Access</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Keys error:', e);
                container.innerHTML = '<div class="text-red-500 text-sm py-4 text-center">Failed to load keys</div>';
            }
        }

        async function loadActivity() {
            const container = document.getElementById('activity-list');
            try {
                const filter = document.getElementById('activity-filter').value;
                const url = `${API}/admin/activity?limit=50${filter ? '&action=' + encodeURIComponent(filter) : ''}`;
                const { data } = await axios.get(url);
                
                if (!data.logs?.length) {
                    container.innerHTML = '<div class="text-neutral-400 text-sm py-8 text-center">No activity recorded yet</div>';
                    return;
                }
                
                container.innerHTML = data.logs.map(l => {
                    const time = new Date(l.timestamp);
                    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dateStr = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    
                    return `
                        <div class="activity-item flex items-center gap-3">
                            <div class="w-16 text-xs text-neutral-400 shrink-0">
                                <div>${timeStr}</div>
                                <div>${dateStr}</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <span class="font-medium text-sm text-neutral-800">${escapeHtml(l.user_name || l.key_prefix || 'System')}</span>
                                <span class="text-sm text-neutral-500 ml-1">${formatAction(l.action)}</span>
                                ${l.target ? `<span class="text-sm text-neutral-700 font-medium ml-1">${escapeHtml(l.target)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Activity error:', e);
                container.innerHTML = '<div class="text-red-500 text-sm py-4 text-center">Failed to load activity</div>';
            }
        }

        function formatAction(action) {
            const actions = {
                'create_user': 'gave access to',
                'revoke_user': 'revoked access for',
                'update_user': 'updated',
                'generate': 'generated a proposal',
                'save_proposal': 'saved a proposal',
                'upload_training': 'uploaded training data',
                'api_call': 'made an API call'
            };
            return actions[action] || action.replace(/_/g, ' ');
        }

        function formatDate(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function openCreateModal() {
            document.getElementById('create-key-form').reset();
            document.querySelectorAll('.perm-check').forEach((cb, i) => cb.checked = i < 2); // Default: read, generate
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('key-name').focus();
        }

        function closeCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        function closeKeyCreatedModal() {
            document.getElementById('key-created-modal').classList.add('hidden');
            newKeyValue = '';
            loadKeys();
            loadStats();
        }

        async function createKey(e) {
            e.preventDefault();
            const btn = document.getElementById('create-btn');
            
            const permissions = [...document.querySelectorAll('.perm-check:checked')].map(c => c.value);
            if (permissions.length === 0) {
                toast('Please select at least one permission', true);
                return;
            }
            
            const name = document.getElementById('key-name').value.trim();
            if (!name) {
                toast('Please enter the user\'s name', true);
                return;
            }
            
            const email = document.getElementById('key-email').value.trim();
            const expiryVal = document.getElementById('key-expiry').value;
            const limitVal = document.getElementById('key-limit').value;
            
            const req = {
                name,
                email: email || null,
                permissions,
                expires_in_days: expiryVal ? parseInt(expiryVal, 10) : null,
                usage_limit: limitVal ? parseInt(limitVal, 10) : null,
                description: document.getElementById('key-desc').value.trim() || null
            };
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const { data } = await axios.post(`${API}/admin/keys`, req);
                newKeyValue = data.api_key;
                document.getElementById('new-key-value').textContent = newKeyValue;
                closeCreateModal();
                document.getElementById('key-created-modal').classList.remove('hidden');
                toast('User access created!');
                loadActivity(); // Refresh activity log
            } catch (e) {
                toast(e.response?.data?.detail || 'Failed to create access', true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Access';
            }
        }

        async function revokeKey(id, name, btnEl) {
            if (!confirm(`Revoke access for "${name}"?\n\nThis will immediately remove their access and cannot be undone.`)) {
                return;
            }
            
            if (btnEl) {
                btnEl.disabled = true;
                btnEl.textContent = '...';
            }
            
            try {
                await axios.delete(`${API}/admin/keys/${id}`);
                toast('Access revoked');
                loadKeys();
                loadStats();
                loadActivity();
            } catch (e) {
                toast(e.response?.data?.detail || 'Failed to revoke access', true);
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.textContent = 'Revoke Access';
                }
            }
        }

        async function copyKey() {
            try {
                await navigator.clipboard.writeText(newKeyValue);
                toast('Key copied to clipboard!');
            } catch {
                // Fallback for older browsers
                const el = document.getElementById('new-key-value');
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                try {
                    document.execCommand('copy');
                    toast('Key copied to clipboard!');
                } catch {
                    toast('Failed to copy. Please select and copy manually.', true);
                }
            }
        }

        // Close modals on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCreateModal();
                closeKeyCreatedModal();
            }
        });

        // Close modals on backdrop click
        document.getElementById('create-modal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeCreateModal();
        });
        document.getElementById('key-created-modal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeKeyCreatedModal();
        });

        // Logout function
        function logout() {
            apiKey = '';
            localStorage.removeItem('admin_api_key');
            showAuth();
        }
    </script>
</body>
</html>
