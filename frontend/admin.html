<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="image.png">
    <title>Admin Dashboard | Proposal Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #fafafa; min-height: 100vh; }
        .input-field { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 14px; font-size: 14px; transition: all 0.15s; }
        .input-field:focus { outline: none; border-color: #171717; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .stat-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #171717; }
        .stat-label { font-size: 13px; color: #737373; margin-top: 4px; }
        .btn-primary { background: #171717; color: #fff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-primary:hover { background: #262626; }
        .btn-primary:disabled { background: #a3a3a3; cursor: not-allowed; }
        .btn-secondary { background: #fff; color: #171717; border: 1px solid #e5e5e5; border-radius: 8px; padding: 10px 16px; font-weight: 500; font-size: 13px; cursor: pointer; }
        .btn-secondary:hover { background: #fafafa; }
        .btn-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 8px; padding: 8px 12px; font-weight: 500; font-size: 12px; cursor: pointer; }
        .btn-danger:hover { background: #fee2e2; }
        .card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fef2f2; color: #dc2626; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-purple { background: #f3e8ff; color: #7c3aed; }
        .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-overlay.hidden { display: none; }
        .auth-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background: #fff; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .toast { position: fixed; bottom: 24px; right: 24px; background: #171717; color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 13px; opacity: 0; transform: translateY(8px); transition: all 0.2s; z-index: 200; }
        .toast.error { background: #dc2626; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .key-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 16px; transition: all 0.15s; }
        .key-card:hover { border-color: #d4d4d4; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .skeleton { background: linear-gradient(90deg, #f5f5f5 25%, #e5e5e5 50%, #f5f5f5 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .nav-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #737373; transition: all 0.15s; cursor: pointer; text-decoration: none; position: relative; }
        .nav-icon:hover { background: #f5f5f5; color: #171717; }
        .nav-icon svg { width: 18px; height: 18px; }
        .nav-icon .tooltip { position: absolute; top: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: #171717; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
        .nav-icon:hover .tooltip { opacity: 1; }
        .user-badge { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; color: #525252; }
        .user-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-overlay hidden" id="auth-overlay">
        <div class="auth-modal">
            <div class="flex items-center gap-3 mb-5">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#171717" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
                <h2 class="text-base font-semibold text-neutral-900">Super Admin Access</h2>
            </div>
            <form onsubmit="authenticate(event)">
                <input type="password" id="api-key-input" class="input-field w-full mb-3" placeholder="Master Admin Key" required>
                <label class="flex items-center gap-2 mb-4 text-xs text-neutral-500 cursor-pointer">
                    <input type="checkbox" id="remember-key" checked class="accent-neutral-900"> Remember me
                </label>
                <button type="submit" class="btn-primary w-full py-3" id="auth-btn">Continue</button>
                <p class="text-xs text-red-500 text-center mt-3 min-h-[16px]" id="auth-error"></p>
            </form>
        </div>
    </div>

    <!-- Create Key Modal -->
    <div class="modal-overlay hidden" id="create-modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-base font-semibold text-neutral-900">Create API Key</h2>
                <button onclick="toggleModal('create-modal')" class="text-neutral-400 hover:text-neutral-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <form onsubmit="createKey(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">Name <span class="text-red-500">*</span></label>
                    <input type="text" id="key-name" class="input-field w-full" placeholder="e.g. John Doe" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">Email</label>
                    <input type="email" id="key-email" class="input-field w-full" placeholder="e.g. john@example.com">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">Role <span class="text-red-500">*</span></label>
                    <div class="flex gap-4 p-3 bg-neutral-50 rounded-lg border border-neutral-100">
                        <label class="flex items-center gap-2 cursor-pointer text-sm">
                            <input type="radio" name="role" value="admin" class="accent-neutral-900"> Admin <span class="text-xs text-neutral-400">(full access)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer text-sm">
                            <input type="radio" name="role" value="user" checked class="accent-neutral-900"> User <span class="text-xs text-neutral-400">(generate only)</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-neutral-700 mb-1">Expires (days)</label>
                    <input type="number" id="key-expiry" class="input-field w-full" placeholder="Never expires" min="1" max="365">
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="toggleModal('create-modal')" class="btn-secondary flex-1">Cancel</button>
                    <button type="submit" class="btn-primary flex-1" id="create-btn">Create Key</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Created Modal -->
    <div class="modal-overlay hidden" id="success-modal">
        <div class="modal-content text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </div>
            <h2 class="text-lg font-semibold text-neutral-900">API Key Created</h2>
            <p class="text-sm text-neutral-500 mt-1 mb-4">Save this key now — won't be shown again!</p>
            <div class="bg-neutral-100 p-4 rounded-lg mb-4 break-all font-mono text-sm text-neutral-800 select-all border border-neutral-200" id="new-key-value"></div>
            <div class="flex gap-3">
                <button onclick="copyKey()" class="btn-secondary flex-1 flex items-center justify-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Copy
                </button>
                <button onclick="toggleModal('success-modal'); loadAll()" class="btn-primary flex-1">Done</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="border-b border-neutral-200 bg-white sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-neutral-900 rounded-lg flex items-center justify-center">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                </div>
                <span class="font-semibold text-neutral-900 text-sm">Admin Dashboard</span>
            </div>
            <div class="flex items-center gap-1">
                <a href="index.html" class="nav-icon" title="Generate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                    <span class="tooltip">Generate</span>
                </a>
                <a href="dashboard.html" class="nav-icon" title="Analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
                    <span class="tooltip">Analytics</span>
                </a>
                <a href="history.html" class="nav-icon" title="History">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span class="tooltip">History</span>
                </a>
                <a href="training.html" class="nav-icon" title="Training">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                    <span class="tooltip">Training</span>
                </a>
                <div class="w-px h-6 bg-neutral-200 mx-2"></div>
                <div class="user-badge"><span class="dot"></span><span>Super Admin</span></div>
                <button onclick="logout()" class="nav-icon" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                    <span class="tooltip">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card"><div class="stat-value" id="stat-total">-</div><div class="stat-label">Total Keys</div></div>
            <div class="stat-card"><div class="stat-value text-green-600" id="stat-active">-</div><div class="stat-label">Active</div></div>
            <div class="stat-card"><div class="stat-value text-blue-600" id="stat-admin">-</div><div class="stat-label">Admins</div></div>
            <div class="stat-card"><div class="stat-value text-purple-600" id="stat-user">-</div><div class="stat-label">Users</div></div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Keys List -->
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-semibold text-neutral-900">API Keys</h2>
                    <button onclick="toggleModal('create-modal')" class="btn-primary text-sm py-2 px-4 inline-flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Create Key
                    </button>
                </div>
                <div class="space-y-3 max-h-[500px] overflow-y-auto" id="keys-list">
                    <div class="key-card"><div class="skeleton h-4 w-3/4 mb-2"></div><div class="skeleton h-3 w-1/2"></div></div>
                    <div class="key-card"><div class="skeleton h-4 w-3/4 mb-2"></div><div class="skeleton h-3 w-1/2"></div></div>
                </div>
            </div>

            <!-- Activity -->
            <div class="card p-6">
                <h2 class="font-semibold text-neutral-900 mb-4">Recent Activity</h2>
                <div class="space-y-2 max-h-[500px] overflow-y-auto" id="activity-list">
                    <div class="flex gap-3 items-center"><div class="skeleton h-8 w-16"></div><div class="skeleton h-4 flex-1"></div></div>
                    <div class="flex gap-3 items-center"><div class="skeleton h-8 w-16"></div><div class="skeleton h-4 flex-1"></div></div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        const API = 'https://ml.genproposals.com/api';
        const KEY_NAME = 'app_api_key';
        let apiKey = localStorage.getItem(KEY_NAME) || '';
        let newKeyValue = '';

        axios.interceptors.request.use(c => { if (apiKey) c.headers['X-API-Key'] = apiKey; return c; });
        axios.interceptors.response.use(r => r, e => { if ([401, 403].includes(e.response?.status)) showAuth(); return Promise.reject(e); });

        document.addEventListener('DOMContentLoaded', () => apiKey ? verifyAndLoad() : showAuth());

        function showAuth() { document.getElementById('auth-overlay').classList.remove('hidden'); document.getElementById('api-key-input').focus(); }
        function hideAuth() { document.getElementById('auth-overlay').classList.add('hidden'); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function toast(msg, err) { const t = document.getElementById('toast'); t.textContent = msg; t.className = `toast show${err ? ' error' : ''}`; setTimeout(() => t.classList.remove('show'), 3000); }
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
        function logout() { apiKey = ''; localStorage.removeItem(KEY_NAME); location.reload(); }

        async function verifyAndLoad() {
            try {
                const { data } = await axios.get(`${API}/admin/verify-super-admin`);
                if (!data.is_super_admin) throw new Error();
                hideAuth();
                loadAll();
            } catch { apiKey = ''; localStorage.removeItem(KEY_NAME); showAuth(); }
        }

        async function authenticate(e) {
            e.preventDefault();
            const btn = document.getElementById('auth-btn'), err = document.getElementById('auth-error');
            apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) { err.textContent = 'Enter key'; return; }
            btn.disabled = true; btn.textContent = 'Verifying...'; err.textContent = '';
            try {
                const { data } = await axios.get(`${API}/admin/verify-super-admin`);
                if (!data.is_super_admin) throw new Error();
                if (document.getElementById('remember-key').checked) localStorage.setItem(KEY_NAME, apiKey);
                hideAuth(); loadAll();
            } catch { err.textContent = 'Super Admin access required'; apiKey = ''; }
            btn.disabled = false; btn.textContent = 'Continue';
        }

        async function loadAll() { await Promise.all([loadStats(), loadKeys(), loadActivity()]); }

        async function loadStats() {
            try {
                const { data } = await axios.get(`${API}/admin/stats`);
                document.getElementById('stat-total').textContent = data.total_keys ?? 0;
                document.getElementById('stat-active').textContent = data.active_keys ?? 0;
                document.getElementById('stat-admin').textContent = data.admin_keys ?? 0;
                document.getElementById('stat-user').textContent = data.user_keys ?? 0;
            } catch { ['stat-total','stat-active','stat-admin','stat-user'].forEach(id => document.getElementById(id).textContent = '–'); }
        }

        async function loadKeys() {
            const el = document.getElementById('keys-list');
            try {
                const { data } = await axios.get(`${API}/admin/keys`);
                if (!data.keys?.length) { el.innerHTML = '<p class="text-center py-8 text-neutral-400">No keys yet</p>'; return; }
                el.innerHTML = data.keys.map(k => `
                    <div class="key-card">
                        <div class="flex items-start justify-between mb-2">
                            <div><div class="font-medium text-neutral-900">${esc(k.name)}</div>${k.email ? `<div class="text-xs text-neutral-400">${esc(k.email)}</div>` : ''}</div>
                            <span class="badge ${k.is_active ? 'badge-green' : 'badge-red'}">${k.is_active ? 'Active' : 'Revoked'}</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="badge ${k.role === 'admin' ? 'badge-blue' : 'badge-purple'}">${k.role}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-neutral-500">
                            <span>${k.expires_at ? 'Expires: ' + new Date(k.expires_at).toLocaleDateString() : 'Never expires'}</span>
                            ${k.is_active ? `<button onclick="revokeKey('${k.id}','${esc(k.name).replace(/'/g, "\\'")}')" class="btn-danger">Revoke</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch { el.innerHTML = '<p class="text-center py-8 text-red-500">Failed to load</p>'; }
        }

        async function loadActivity() {
            const el = document.getElementById('activity-list');
            try {
                const { data } = await axios.get(`${API}/admin/activity?limit=30`);
                if (!data.activities?.length) { el.innerHTML = '<p class="text-center py-8 text-neutral-400">No activity</p>'; return; }
                el.innerHTML = data.activities.map(a => `
                    <div class="py-2 border-b border-neutral-100 flex items-center gap-3">
                        <div class="text-xs text-neutral-400 w-16 shrink-0">${new Date(a.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                        <div class="text-sm"><span class="font-medium">${esc(a.actor)}</span> <span class="text-neutral-500">${a.action.replace(/_/g, ' ')}</span></div>
                    </div>
                `).join('');
            } catch { el.innerHTML = '<p class="text-center py-8 text-red-500">Failed to load</p>'; }
        }

        async function createKey(e) {
            e.preventDefault();
            const btn = document.getElementById('create-btn');
            const name = document.getElementById('key-name').value.trim();
            const role = document.querySelector('input[name="role"]:checked')?.value;
            if (!name || !role) { toast('Name and role required', true); return; }
            btn.disabled = true; btn.textContent = 'Creating...';
            try {
                const { data } = await axios.post(`${API}/admin/keys`, {
                    name,
                    email: document.getElementById('key-email').value.trim() || null,
                    role,
                    expires_in_days: parseInt(document.getElementById('key-expiry').value) || null
                });
                newKeyValue = data.api_key;
                document.getElementById('new-key-value').textContent = newKeyValue;
                toggleModal('create-modal');
                toggleModal('success-modal');
                toast('Key created!');
            } catch (err) { toast(err.response?.data?.detail || 'Failed', true); }
            btn.disabled = false; btn.textContent = 'Create Key';
        }

        async function revokeKey(id, name) {
            if (!confirm(`Revoke "${name}"?`)) return;
            try { await axios.delete(`${API}/admin/keys/${id}`); toast('Revoked'); loadAll(); }
            catch { toast('Failed to revoke', true); }
        }

        async function copyKey() {
            try { await navigator.clipboard.writeText(newKeyValue); toast('Copied!'); }
            catch { toast('Copy failed', true); }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') ['create-modal', 'success-modal'].forEach(id => document.getElementById(id).classList.add('hidden')); });
    </script>
</body>
</html>
